13d4c93a7a5a27c4bff0f35df3d2313e
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.getUserAvatar = exports.getUserPurchasedItems = exports.getUserAdventures = exports.completeChallenge = exports.startAdventure = exports.getUserInterests = exports.getUserRank = exports.updateLocation = exports.getLocation = exports.updateUserCoins = exports.getUserCoins = exports.updateUserStars = exports.getUserStars = exports.updatePassword = exports.deleteUser = exports.editUserProfile = exports.createUser = exports.getUserById = exports.getUsers = void 0;
const bcrypt_1 = __importDefault(require("bcrypt"));
const user_model_1 = require("../models/user.model");
const error_1 = require("../utils/error");
const checkId_1 = require("../utils/checkId");
const adventure_model_1 = require("../models/adventure.model");
const family_model_1 = require("../models/family.model");
const recalculateFamilyMemberRanks_1 = require("../utils/recalculateFamilyMemberRanks");
const email_service_1 = require("../services/email.service");
const generateSecurePassword_1 = require("../utils/generateSecurePassword");
// API to get all users
const getUsers = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const users = yield user_model_1.User.find();
        res.status(200).send(users);
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving users", res, status: 500 });
    }
});
exports.getUsers = getUsers;
// API to get a user based on his Id
const getUserById = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { userId } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        const targetUserId = userId || req.user._id;
        if (!(0, checkId_1.checkId)({ id: targetUserId, res }))
            return;
        let projection = '_id name email birthday role avatar gender stars coins interests nbOfTasksCompleted rankInFamily memberSince familyId dailyMessage isTempPassword'; // Basic user info
        // Fetch the user with specific fields
        const user = yield user_model_1.User.findById(targetUserId).select(projection);
        // If user not found, return 404
        if (!user) {
            return (0, error_1.throwError)({ message: "User not found", res, status: 404 });
        }
        if (req.user._id.toString() !== targetUserId.toString() && ['parent', 'child'].includes(req.user.role) && req.user.email != user.email) {
            return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
        }
        res.status(200).json({ message: "Retrieving user successfully", user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user", res, status: 500 });
    }
});
exports.getUserById = getUserById;
// API to create user
const createUser = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const data = req.body;
        const { name, birthday, gender, role, avatar, interests } = data;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        if (req.user.role === "child") {
            return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
        }
        // verify all fields are filled
        if (!name || !birthday || !gender || !role || !avatar || !interests) {
            return (0, error_1.throwError)({ message: "All required fields must be filled.", res, status: 400 });
        }
        const email = req.user.email;
        const existingUser = yield user_model_1.User.findOne({
            name: name,
            email: email
        });
        if (existingUser) {
            return (0, error_1.throwError)({ message: "This username is already taken for this email.", res, status: 409 });
        }
        if (!Array.isArray(interests)) {
            return (0, error_1.throwError)({ message: "Interests must be an array.", res, status: 400 });
        }
        // Gender Validation
        const validGenders = ['male', 'female'];
        if (!validGenders.includes(gender)) {
            return (0, error_1.throwError)({ message: "Gender must be either 'male' or 'female'.", res, status: 400 });
        }
        // Role validation
        const validRoles = ['owner', 'parent', 'child', 'admin'];
        if (!validRoles.includes(role)) {
            return (0, error_1.throwError)({ message: "Invalid role.", res, status: 400 });
        }
        // Birthday Validation
        if (isNaN(new Date(birthday).getTime())) {
            return (0, error_1.throwError)({ message: "Invalid birthday format.", res, status: 400 });
        }
        const generatedPassword = (0, generateSecurePassword_1.generateSecurePassword)();
        const hashedPassword = yield bcrypt_1.default.hash(generatedPassword, 12);
        // Find the parent's family
        const family = yield family_model_1.Family.findOne({ email: req.user.email });
        if (!family) {
            return (0, error_1.throwError)({ message: "Family not found.", res, status: 404 });
        }
        // Create the user with the parent's familyId
        const user = yield user_model_1.User.create(Object.assign(Object.assign({}, data), { email: email, password: hashedPassword, familyId: family._id // Link to parent's family
         }));
        // Add the new user to the family's members list
        if (!family.members.includes(user.id)) {
            family.members.push({ _id: user.id, role, name, gender, avatar });
            yield family.save();
        }
        // Recalculate the ranks after adding the new user
        yield (0, recalculateFamilyMemberRanks_1.recalculateFamilyMemberRanks)(family._id, user);
        const from = `"Guardian Grove" <${process.env.EMAIL_USERNAME}>`;
        const to = email;
        const subject = `Welcome to Guardian Grove - ${name}'s Account Details`;
        const html = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; color: #333;">
                <div style="background-color: #f8f9fa; padding: 20px; border-radius: 5px;">
                    <h2 style="color: #2c3e50;">Welcome to Guardian Grove!</h2>
                    <p>Hello ${req.user.name},</p>
                    
                    <div style="background-color: white; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #3498db;">
                        <p>You've successfully created a <strong>${role}</strong> account for <strong>${name}</strong>.</p>
                        <p>Here are the login details:</p>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd; width: 120px;"><strong>Username:</strong></td>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd;">${name}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px;"><strong>Temporary Password:</strong></td>
                                <td style="padding: 8px;">${generatedPassword}</td>
                            </tr>
                        </table>
                    </div>
                    
                    <p style="color: #e74c3c; font-weight: bold;">Please change this password after first login.</p>
                    
                    <p>If you didn't request this account creation, please contact our support immediately.</p>
                    
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee;">
                        <p>Best regards,</p>
                        <p><strong>The Guardian Grove Team</strong></p>
                        <p style="font-size: 12px; color: #7f8c8d;">This is an automated message - please do not reply directly to this email.</p>
                    </div>
                </div>
            </div>
        `;
        // Send email with the temporary password
        yield (0, email_service_1.sendMail)(from, to, subject, html);
        yield user.save();
        res.status(200).send({ message: "User created successfully, password email sent.", user });
    }
    catch (error) {
        if (error instanceof Error) {
            // Handle MongoDB duplicate key error (11000)
            if (error.code === 11000) {
                return (0, error_1.throwError)({
                    message: "A user with this name and email already exists.",
                    res,
                    status: 409
                });
            }
            else {
                return (0, error_1.throwError)({ message: error.message, res, status: 500 });
            }
        }
        else {
            return (0, error_1.throwError)({ message: "An unknown error occurred.", res, status: 500 });
        }
    }
});
exports.createUser = createUser;
// API to edit user profile
const editUserProfile = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { userId, name, birthday, gender, avatar, role } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        if ((role) && !['parent', 'admin', 'owner'].includes(req.user.role)) {
            return (0, error_1.throwError)({ message: "Forbidden: You cannot change role nor email", res, status: 403 });
        }
        let user;
        if (userId) {
            if (!(0, checkId_1.checkId)({ id: userId, res }))
                return;
            if (req.user._id.toString() !== userId && !['parent', 'admin', 'owner'].includes(req.user.role)) {
                return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
            }
            user = yield user_model_1.User.findById(userId);
            if (!user) {
                return (0, error_1.throwError)({ message: "User not found", res, status: 404 });
            }
            if (req.user.role !== "admin" && req.user.email !== user.email) {
                return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
            }
        }
        else {
            user = req.user;
        }
        // Check if a user with the same email and name exists
        if (name) {
            const existingUser = yield user_model_1.User.findOne({ email: user.email, name, _id: { $ne: user._id } });
            if (existingUser) {
                return (0, error_1.throwError)({ message: "A user with the same email and name already exists.", res, status: 400 });
            }
            user.name = name;
        }
        if (name)
            user.name = name;
        if (birthday)
            user.birthday = birthday;
        if (gender)
            user.gender = gender;
        if (avatar)
            user.avatar = avatar;
        if (role)
            user.role = role;
        yield user.save();
        res.status(200).send({ message: "User profile updated successfully", user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Failed to update. An unknown error occurred.", res, status: 500 });
    }
});
exports.editUserProfile = editUserProfile;
// API to delete user
const deleteUser = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { userId } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        let user;
        if (userId) {
            if (!(0, checkId_1.checkId)({ id: userId, res }))
                return;
            if (req.user._id.toString() !== userId && !['parent', 'admin', 'owner'].includes(req.user.role)) {
                return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
            }
            user = yield user_model_1.User.findById(userId);
            if (!user) {
                return (0, error_1.throwError)({ message: "User not found", res, status: 404 });
            }
            if (req.user.role !== "admin" && req.user.email !== user.email) {
                return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
            }
        }
        else {
            user = req.user;
        }
        // Prevent deleting the last parent in a family
        const family = yield family_model_1.Family.findById(user.familyId);
        if (family) {
            const parentsCount = yield user_model_1.User.countDocuments({ familyId: family._id, role: 'parent' });
            if (user.role === 'parent' && parentsCount <= 1) {
                return (0, error_1.throwError)({ message: "Cannot delete the last parent in the family", res, status: 400 });
            }
            // Remove user from the family members list
            family.members = family.members.filter((member) => member._id.toString() !== user._id.toString());
            yield family.save();
        }
        // Delete the user
        yield user_model_1.User.findByIdAndDelete(user._id);
        res.status(200).send({ message: "User deleted successfully", user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Failed to delete. An unknown error occurred.", res, status: 500 });
    }
});
exports.deleteUser = deleteUser;
// API to update password
const updatePassword = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { userId, oldPassword, newPassword, confirmPassword } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        let user;
        if (userId) {
            if (!(0, checkId_1.checkId)({ id: userId, res }))
                return;
            if (req.user._id.toString() !== userId && req.user.role !== "admin") {
                return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
            }
            user = yield user_model_1.User.findById(userId);
            if (!user) {
                return (0, error_1.throwError)({ message: "User not found", res, status: 404 });
            }
        }
        else {
            user = req.user;
        }
        // Validate required fields
        if (!oldPassword || !newPassword || !confirmPassword) {
            return (0, error_1.throwError)({ message: "All fields are required.", res, status: 400 });
        }
        if (newPassword !== confirmPassword) {
            return (0, error_1.throwError)({ message: "Passwords do not match.", res, status: 400 });
        }
        // Verify old password
        const isMatch = yield bcrypt_1.default.compare(oldPassword, user.password);
        if (!isMatch) {
            return (0, error_1.throwError)({ message: "Old password is incorrect.", res, status: 400 });
        }
        // Check if the new password is different from the old one
        const isSamePassword = yield bcrypt_1.default.compare(newPassword, req.user.password);
        if (isSamePassword) {
            return (0, error_1.throwError)({ message: "New password cannot be the same as the old password.", res, status: 400 });
        }
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        if (!passwordRegex.test(newPassword)) {
            return (0, error_1.throwError)({
                message: "Password must be at least 8 characters long, include an uppercase letter, lowercase letter, a number, and a special character.",
                res,
                status: 400
            });
        }
        // Hash new password
        const hashedPassword = yield bcrypt_1.default.hash(newPassword, 10);
        user.password = hashedPassword;
        user.isTempPassword = false;
        yield user.save();
        // Return success response
        res.status(200).send({ message: "Password updated successfully.", password: newPassword });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Failed to update password.", res, status: 500 });
    }
});
exports.updatePassword = updatePassword;
// API to get user's stars
const getUserStars = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "Stars retrieved successfully", stars: req.user.stars });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user stars", res, status: 500 });
    }
});
exports.getUserStars = getUserStars;
// API to update user's stars
const updateUserStars = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { stars } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        if (stars === undefined || typeof stars !== "number" || stars < 0) {
            return (0, error_1.throwError)({ message: "Stars must be a valid number.", res, status: 400 });
        }
        req.user.stars += stars;
        yield req.user.save();
        if (!req.user.familyId) {
            return (0, error_1.throwError)({ message: "No family id", res, status: 400 });
        }
        yield family_model_1.Family.findByIdAndUpdate(req.user.familyId, { $inc: { totalStars: stars } });
        yield (0, recalculateFamilyMemberRanks_1.recalculateFamilyMemberRanks)(req.user.familyId, req.user);
        res.status(200).send({ message: "User stars updated successfully", user: req.user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error updating user stars", res, status: 500 });
    }
});
exports.updateUserStars = updateUserStars;
// API to get user's coins
const getUserCoins = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "Coins retrieved successfully", coins: req.user.coins });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user coins", res, status: 500 });
    }
});
exports.getUserCoins = getUserCoins;
// API to update user's coins
const updateUserCoins = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { coins } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        if (coins === undefined || typeof coins !== "number") {
            return (0, error_1.throwError)({ message: "Stars must be a valid number.", res, status: 400 });
        }
        req.user.coins += coins;
        yield req.user.save();
        res.status(200).send({ message: "User coins updated successfully", user: req.user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error updating user coins", res, status: 500 });
    }
});
exports.updateUserCoins = updateUserCoins;
// API to get user's location
const getLocation = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "Location retrieved successfully", location: req.user.currentLocation });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user location", res, status: 500 });
    }
});
exports.getLocation = getLocation;
// API to update user's current location
const updateLocation = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { currentLocation } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        if (typeof currentLocation !== "string" || currentLocation.trim() === "") {
            return (0, error_1.throwError)({ message: "Location must be valid.", res, status: 400 });
        }
        req.user.currentLocation = currentLocation;
        yield req.user.save();
        res.status(200).send({ message: "User location updated successfully", user: req.user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error updating user location", res, status: 500 });
    }
});
exports.updateLocation = updateLocation;
// API to get user's rank
const getUserRank = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "Rank retrieved successfully", Rank: req.user.rankInFamily });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user rank", res, status: 500 });
    }
});
exports.getUserRank = getUserRank;
// API to update user's rank
/*export const updateUserRank = async(req:CustomRequest, res: Response): Promise<void> => {
    try{
        const { rank }: { rank: number } = req.body;

        if (!req.user) {
            return throwError({ message: "Unauthorized", res, status: 401});
        }

        if (rank === undefined || typeof rank !== "number"){
            return throwError({ message: "Rank must be a valid number.", res, status: 400});
        }

        req.user.rankInFamily = rank;
        await req.user.save();

        res.status(200).send({ message: "User rank updated successfully", user: req.user });
    }catch(error){
        return throwError({ message: "Error updating user rank", res, status: 500});
    }
};*/
// API to get user's interesets
const getUserInterests = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "Interests retrieved successfully", Interests: req.user.interests });
    }
    catch (error) {
        (0, error_1.throwError)({ message: "Error retrieving user interests", res, status: 500 });
    }
});
exports.getUserInterests = getUserInterests;
// API to start an adventure
const startAdventure = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { adventureId } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        const userId = req.user._id;
        if (!(0, checkId_1.checkId)({ id: adventureId, res }))
            return;
        if (!(0, checkId_1.checkId)({ id: userId.toString(), res }))
            return;
        // Find the adventure by adventureId
        const adventure = yield adventure_model_1.Adventure.findById(adventureId);
        if (!adventure) {
            return (0, error_1.throwError)({ message: "Adventure not found", res, status: 404 });
        }
        const existingAdventureProgress = req.user.adventures.find((adventureProgress) => adventureProgress.adventureId.equals(adventureId));
        if (existingAdventureProgress) {
            return (0, error_1.throwError)({ message: "Adventure already started", res, status: 400 });
        }
        // Add adventure to user's adventures
        const newAdventureProgress = {
            adventureId: adventureId,
            challenges: adventure.challenges.map((challenge) => ({
                challengeId: challenge._id,
                isCompleted: false,
            })),
            status: "in-progress",
            isAdventureCompleted: false,
            starsReward: adventure.starsReward,
            coinsReward: adventure.coinsReward,
            progress: 0,
        };
        req.user.adventures.push(newAdventureProgress);
        yield req.user.save();
        res.status(200).send({ message: "Adventure started successfully", user: req.user });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "An unknown error occurred while starting the adventure.", res, status: 500 });
    }
});
exports.startAdventure = startAdventure;
const completeChallenge = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { adventureId, challengeId } = req.body;
        if (!(0, checkId_1.checkId)({ id: adventureId, res }))
            return;
        if (!(0, checkId_1.checkId)({ id: challengeId, res }))
            return;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        const user = req.user;
        const adventureProgress = user.adventures.find((adventure) => adventure.adventureId.equals(adventureId));
        if (!adventureProgress) {
            return (0, error_1.throwError)({ message: "Adventure not found in user's profile", res, status: 404 });
        }
        const challenge = adventureProgress.challenges.find((challenge) => challenge.challengeId.equals(challengeId));
        if (!challenge) {
            return (0, error_1.throwError)({ message: "Challenge not found in adventure", res, status: 404 });
        }
        // Fetch the full adventure to get challenge rewards
        const adventure = yield adventure_model_1.Adventure.findById(adventureId).lean();
        if (!adventure) {
            return (0, error_1.throwError)({ message: "Adventure not found", res, status: 404 });
        }
        const targetChallenge = adventure.challenges.find(ch => ch._id.equals(challengeId));
        if (!targetChallenge) {
            return (0, error_1.throwError)({ message: "Challenge data not found in adventure", res, status: 404 });
        }
        // Mark challenge as complete and add rewards
        challenge.isCompleted = true;
        challenge.completedAt = new Date();
        const starsReward = targetChallenge.starsReward;
        const coinsReward = targetChallenge.coinsReward;
        user.stars += starsReward;
        user.coins += coinsReward;
        adventureProgress.progress = (adventureProgress.challenges.filter(challenge => challenge.isCompleted).length / adventureProgress.challenges.length) * 100;
        let adventureStars = 0;
        if (adventureProgress.progress === 100) {
            adventureProgress.isAdventureCompleted = true;
            adventureProgress.status = 'completed';
            adventureStars = adventureProgress.starsReward;
            user.coins += adventureProgress.coinsReward;
            user.stars += adventureStars;
        }
        // Update the family total stars
        if (user.familyId) {
            const totalStars = starsReward + adventureStars;
            yield family_model_1.Family.findByIdAndUpdate(user.familyId, {
                $inc: { totalStars: totalStars }
            });
            yield (0, recalculateFamilyMemberRanks_1.recalculateFamilyMemberRanks)(user.familyId, user);
        }
        yield user.save();
        res.status(200).json({ message: "Challenge completed successfully", adventureProgress });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "An unknown error occurred while completing the challenge.", res, status: 500 });
    }
});
exports.completeChallenge = completeChallenge;
// API to get user's adventures
const getUserAdventures = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        res.status(200).send({ message: "User adventures retrieved successfully", Adventure: req.user.adventures });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving user adventures", res, status: 500 });
    }
});
exports.getUserAdventures = getUserAdventures;
//API to get user's purchased items
const getUserPurchasedItems = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { userId } = req.body;
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        const targetUserId = userId || req.user._id;
        if (!(0, checkId_1.checkId)({ id: targetUserId, res }))
            return;
        const isAuthorized = req.user._id.toString() === targetUserId.toString();
        if (!isAuthorized) {
            return (0, error_1.throwError)({ message: "Forbidden", res, status: 403 });
        }
        // Fetch only itemIds from purchasedItems
        const user = yield user_model_1.User.findById(targetUserId).select('purchasedItems.itemId');
        if (!user) {
            return (0, error_1.throwError)({ message: "User not found", res, status: 404 });
        }
        const purchasedItemIds = user.purchasedItems.map((item) => item.itemId);
        res.status(200).json({ message: "Purchased items retrieved successfully", purchasedItems: purchasedItemIds });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error retrieving purchased items", res, status: 500 });
    }
});
exports.getUserPurchasedItems = getUserPurchasedItems;
//API to get user's avatar
const getUserAvatar = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        if (!req.user) {
            return (0, error_1.throwError)({ message: "Unauthorized", res, status: 401 });
        }
        const user = req.user;
        res.status(200).json({ message: "Avatar retrieved successfully", avatar: user.avatar });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error fetching avatar", res, status: 500 });
    }
});
exports.getUserAvatar = getUserAvatar;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEZXNrdG9wXFxndWFyZGlhbi1ncm92ZVxcZ3VhcmRpYW4tZ3JvdmUtYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcdXNlci5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUNBLG9EQUE0QjtBQUM1QixxREFBNEM7QUFDNUMsMENBQTRDO0FBRTVDLDhDQUEyQztBQUMzQywrREFBc0Q7QUFFdEQseURBQWdEO0FBQ2hELHdGQUFxRjtBQUVyRiw2REFBcUQ7QUFDckQsNEVBQXlFO0FBRXpFLHVCQUF1QjtBQUNoQixNQUFNLFFBQVEsR0FBRyxDQUFNLEdBQVksRUFBRSxHQUFhLEVBQWlCLEVBQUU7SUFDeEUsSUFBRyxDQUFDO1FBQ0EsTUFBTSxLQUFLLEdBQUcsTUFBTSxpQkFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2hDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFBQSxPQUFNLEtBQUssRUFBQyxDQUFDO1FBQ1YsT0FBTyxJQUFBLGtCQUFVLEVBQUMsRUFBRSxPQUFPLEVBQUUsd0JBQXdCLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDO0lBQzlFLENBQUM7QUFDTCxDQUFDLENBQUEsQ0FBQztBQVBXLFFBQUEsUUFBUSxZQU9uQjtBQUVGLG9DQUFvQztBQUM3QixNQUFNLFdBQVcsR0FBRyxDQUFPLEdBQWtCLEVBQUUsR0FBYSxFQUFpQixFQUFFO0lBQ2xGLElBQUksQ0FBQztRQUNELE1BQU0sRUFBRSxNQUFNLEVBQUUsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRTVCLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDWixPQUFPLElBQUEsa0JBQVUsRUFBQyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FB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LE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7SUFDekYsQ0FBQztBQUNMLENBQUMsQ0FBQSxDQUFDO0FBOUJXLFFBQUEscUJBQXFCLHlCQThCaEM7QUFFRiwwQkFBMEI7QUFDbkIsTUFBTSxhQUFhLEdBQUcsQ0FBTyxHQUFrQixFQUFFLEdBQWEsRUFBRSxFQUFFO0lBQ3JFLElBQUksQ0FBQztRQUVELElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDWixPQUFPLElBQUEsa0JBQVUsRUFBQyxFQUFFLE9BQU8sRUFBRSxjQUFjLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCxNQUFNLElBQUksR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDO1FBRXRCLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEVBQUMsT0FBTyxFQUFFLCtCQUErQixFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQztJQUMzRixDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNiLE9BQU8sSUFBQSxrQkFBVSxFQUFDLEVBQUUsT0FBTyxFQUFFLHVCQUF1QixFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQztJQUM3RSxDQUFDO0FBQ0wsQ0FBQyxDQUFBLENBQUM7QUFiVyxRQUFBLGFBQWEsaUJBYXhCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRGVza3RvcFxcZ3VhcmRpYW4tZ3JvdmVcXGd1YXJkaWFuLWdyb3ZlLWJhY2tlbmRcXHNyY1xcY29udHJvbGxlcnNcXHVzZXIuY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXF1ZXN0LCBSZXNwb25zZSB9IGZyb20gJ2V4cHJlc3MnO1xyXG5pbXBvcnQgYmNyeXB0IGZyb20gXCJiY3J5cHRcIjtcclxuaW1wb3J0IHsgVXNlciB9IGZyb20gXCIuLi9tb2RlbHMvdXNlci5tb2RlbFwiO1xyXG5pbXBvcnQgeyB0aHJvd0Vycm9yIH0gZnJvbSAnLi4vdXRpbHMvZXJyb3InO1xyXG5pbXBvcnQgeyBDdXN0b21SZXF1ZXN0IH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9jdXN0b21SZXF1ZXN0JztcclxuaW1wb3J0IHsgY2hlY2tJZCB9IGZyb20gJy4uL3V0aWxzL2NoZWNrSWQnO1xyXG5pbXBvcnQgeyBBZHZlbnR1cmUgfSBmcm9tICcuLi9tb2RlbHMvYWR2ZW50dXJlLm1vZGVsJztcclxuaW1wb3J0IHsgSUFkdmVudHVyZVByb2dyZXNzIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9JQWR2ZW50dXJlUHJvZ3Jlc3MnO1xyXG5pbXBvcnQgeyBGYW1pbHkgfSBmcm9tICcuLi9tb2RlbHMvZmFtaWx5Lm1vZGVsJztcclxuaW1wb3J0IHsgcmVjYWxjdWxhdGVGYW1pbHlNZW1iZXJSYW5rcyB9IGZyb20gJy4uL3V0aWxzL3JlY2FsY3VsYXRlRmFtaWx5TWVtYmVyUmFua3MnO1xyXG5pbXBvcnQgbm9kZW1haWxlciBmcm9tIFwibm9kZW1haWxlclwiO1xyXG5pbXBvcnQgeyBzZW5kTWFpbCB9IGZyb20gJy4uL3NlcnZpY2VzL2VtYWlsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBnZW5lcmF0ZVNlY3VyZVBhc3N3b3JkIH0gZnJvbSAnLi4vdXRpbHMvZ2VuZXJhdGVTZWN1cmVQYXNzd29yZCc7XHJcblxyXG4vLyBBUEkgdG8gZ2V0IGFsbCB1c2Vyc1xyXG5leHBvcnQgY29uc3QgZ2V0VXNlcnMgPSBhc3luYyhyZXE6IFJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBjb25zdCB1c2VycyA9IGF3YWl0IFVzZXIuZmluZCgpO1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHVzZXJzKTtcclxuICAgIH1jYXRjaChlcnJvcil7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkVycm9yIHJldHJpZXZpbmcgdXNlcnNcIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59O1xyXG5cclxuLy8gQVBJIHRvIGdldCBhIHVzZXIgYmFzZWQgb24gaGlzIElkXHJcbmV4cG9ydCBjb25zdCBnZXRVc2VyQnlJZCA9IGFzeW5jIChyZXE6IEN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHVzZXJJZCB8fCByZXEudXNlci5faWQ7XHJcblxyXG4gICAgICAgIGlmICghY2hlY2tJZCh7IGlkOiB0YXJnZXRVc2VySWQsIHJlcyB9KSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBsZXQgcHJvamVjdGlvbiA9ICdfaWQgbmFtZSBlbWFpbCBiaXJ0aGRheSByb2xlIGF2YXRhciBnZW5kZXIgc3RhcnMgY29pbnMgaW50ZXJlc3RzIG5iT2ZUYXNrc0NvbXBsZXRlZCByYW5rSW5GYW1pbHkgbWVtYmVyU2luY2UgZmFtaWx5SWQgZGFpbHlNZXNzYWdlIGlzVGVtcFBhc3N3b3JkJzsgIC8vIEJhc2ljIHVzZXIgaW5mb1xyXG5cclxuICAgICAgICAvLyBGZXRjaCB0aGUgdXNlciB3aXRoIHNwZWNpZmljIGZpZWxkc1xyXG4gICAgICAgIGNvbnN0IHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHRhcmdldFVzZXJJZCkuc2VsZWN0KHByb2plY3Rpb24pO1xyXG5cclxuICAgICAgICAvLyBJZiB1c2VyIG5vdCBmb3VuZCwgcmV0dXJuIDQwNFxyXG4gICAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVXNlciBub3QgZm91bmRcIiwgcmVzLCBzdGF0dXM6IDQwNCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChyZXEudXNlci5faWQudG9TdHJpbmcoKSAhPT0gdGFyZ2V0VXNlcklkLnRvU3RyaW5nKCkgJiYgWydwYXJlbnQnLCAnY2hpbGQnXS5pbmNsdWRlcyhyZXEudXNlci5yb2xlKSAmJiByZXEudXNlci5lbWFpbCAhPSB1c2VyLmVtYWlsKXtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZvcmJpZGRlblwiLCByZXMsIHN0YXR1czogNDAzIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLmpzb24oeyBtZXNzYWdlOiBcIlJldHJpZXZpbmcgdXNlciBzdWNjZXNzZnVsbHlcIiwgdXNlciB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkVycm9yIHJldHJpZXZpbmcgdXNlclwiLCByZXMsIHN0YXR1czogNTAwIH0pO1xyXG4gICAgfVxyXG59O1xyXG5cclxuLy8gQVBJIHRvIGNyZWF0ZSB1c2VyXHJcbmV4cG9ydCBjb25zdCBjcmVhdGVVc2VyID0gYXN5bmMgKHJlcTogQ3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgY29uc3QgeyBuYW1lLCBiaXJ0aGRheSwgZ2VuZGVyLCByb2xlLCBhdmF0YXIsIGludGVyZXN0cyB9ID0gZGF0YTtcclxuXHJcbiAgICAgICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIlVuYXV0aG9yaXplZFwiLCByZXMsIHN0YXR1czogNDAxIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZihyZXEudXNlci5yb2xlID09PSBcImNoaWxkXCIpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRm9yYmlkZGVuXCIsIHJlcywgc3RhdHVzOiA0MDMgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyB2ZXJpZnkgYWxsIGZpZWxkcyBhcmUgZmlsbGVkXHJcbiAgICAgICAgaWYgKCFuYW1lIHx8ICFiaXJ0aGRheSB8fCAhZ2VuZGVyIHx8ICFyb2xlIHx8ICFhdmF0YXIgfHwgIWludGVyZXN0cykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiQWxsIHJlcXVpcmVkIGZpZWxkcyBtdXN0IGJlIGZpbGxlZC5cIiwgcmVzLCBzdGF0dXM6IDQwMH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgZW1haWwgPSByZXEudXNlci5lbWFpbDtcclxuXHJcbiAgICAgICAgY29uc3QgZXhpc3RpbmdVc2VyID0gYXdhaXQgVXNlci5maW5kT25lKHtcclxuICAgICAgICAgICAgbmFtZTogbmFtZSxcclxuICAgICAgICAgICAgZW1haWw6IGVtYWlsICAgXHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nVXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVGhpcyB1c2VybmFtZSBpcyBhbHJlYWR5IHRha2VuIGZvciB0aGlzIGVtYWlsLlwiLCByZXMsIHN0YXR1czogNDA5fSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkoaW50ZXJlc3RzKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiSW50ZXJlc3RzIG11c3QgYmUgYW4gYXJyYXkuXCIsIHJlcywgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBHZW5kZXIgVmFsaWRhdGlvblxyXG4gICAgICAgIGNvbnN0IHZhbGlkR2VuZGVycyA9IFsnbWFsZScsICdmZW1hbGUnXTtcclxuICAgICAgICBpZiAoIXZhbGlkR2VuZGVycy5pbmNsdWRlcyhnZW5kZXIpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJHZW5kZXIgbXVzdCBiZSBlaXRoZXIgJ21hbGUnIG9yICdmZW1hbGUnLlwiLCByZXMsIHN0YXR1czogNDAwfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBSb2xlIHZhbGlkYXRpb25cclxuICAgICAgICBjb25zdCB2YWxpZFJvbGVzID0gWydvd25lcicsICdwYXJlbnQnLCAnY2hpbGQnLCAnYWRtaW4nXTtcclxuICAgICAgICBpZiAoIXZhbGlkUm9sZXMuaW5jbHVkZXMocm9sZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkludmFsaWQgcm9sZS5cIiwgcmVzLCBzdGF0dXM6IDQwMH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQmlydGhkYXkgVmFsaWRhdGlvblxyXG4gICAgICAgIGlmIChpc05hTihuZXcgRGF0ZShiaXJ0aGRheSkuZ2V0VGltZSgpKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiSW52YWxpZCBiaXJ0aGRheSBmb3JtYXQuXCIsIHJlcywgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCBnZW5lcmF0ZWRQYXNzd29yZCA9IGdlbmVyYXRlU2VjdXJlUGFzc3dvcmQoKTtcclxuICAgICAgICBjb25zdCBoYXNoZWRQYXNzd29yZCA9IGF3YWl0IGJjcnlwdC5oYXNoKGdlbmVyYXRlZFBhc3N3b3JkLCAxMik7XHJcbiAgICAgICAgXHJcbiAgICAgICAgLy8gRmluZCB0aGUgcGFyZW50J3MgZmFtaWx5XHJcbiAgICAgICAgY29uc3QgZmFtaWx5ID0gYXdhaXQgRmFtaWx5LmZpbmRPbmUoeyBlbWFpbDogcmVxLnVzZXIuZW1haWwgfSk7XHJcbiAgICAgICAgaWYgKCFmYW1pbHkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZhbWlseSBub3QgZm91bmQuXCIsIHJlcywgc3RhdHVzOiA0MDQgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBDcmVhdGUgdGhlIHVzZXIgd2l0aCB0aGUgcGFyZW50J3MgZmFtaWx5SWRcclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5jcmVhdGUoe1xyXG4gICAgICAgICAgICAuLi5kYXRhLFxyXG4gICAgICAgICAgICBlbWFpbDogZW1haWwsXHJcbiAgICAgICAgICAgIHBhc3N3b3JkOiBoYXNoZWRQYXNzd29yZCxcclxuICAgICAgICAgICAgZmFtaWx5SWQ6IGZhbWlseS5faWQgIC8vIExpbmsgdG8gcGFyZW50J3MgZmFtaWx5XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIEFkZCB0aGUgbmV3IHVzZXIgdG8gdGhlIGZhbWlseSdzIG1lbWJlcnMgbGlzdFxyXG4gICAgICAgIGlmICghZmFtaWx5Lm1lbWJlcnMuaW5jbHVkZXModXNlci5pZCkpIHtcclxuICAgICAgICAgICAgZmFtaWx5Lm1lbWJlcnMucHVzaCh7X2lkOiB1c2VyLmlkLCByb2xlLCBuYW1lLCBnZW5kZXIsIGF2YXRhcn0pO1xyXG4gICAgICAgICAgICBhd2FpdCBmYW1pbHkuc2F2ZSgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUmVjYWxjdWxhdGUgdGhlIHJhbmtzIGFmdGVyIGFkZGluZyB0aGUgbmV3IHVzZXJcclxuICAgICAgICBhd2FpdCByZWNhbGN1bGF0ZUZhbWlseU1lbWJlclJhbmtzKGZhbWlseS5faWQsIHVzZXIpO1xyXG5cclxuICAgICAgICBjb25zdCBmcm9tOiBzdHJpbmcgPSBgXCJHdWFyZGlhbiBHcm92ZVwiIDwke3Byb2Nlc3MuZW52LkVNQUlMX1VTRVJOQU1FfT5gO1xyXG4gICAgICAgIGNvbnN0IHRvOiBzdHJpbmcgPSBlbWFpbDtcclxuICAgICAgICBjb25zdCBzdWJqZWN0ID0gYFdlbGNvbWUgdG8gR3VhcmRpYW4gR3JvdmUgLSAke25hbWV9J3MgQWNjb3VudCBEZXRhaWxzYDtcclxuICAgICAgICBjb25zdCBodG1sID0gYFxyXG4gICAgICAgICAgICA8ZGl2IHN0eWxlPVwiZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOyBtYXgtd2lkdGg6IDYwMHB4OyBtYXJnaW46IDAgYXV0bzsgY29sb3I6ICMzMzM7XCI+XHJcbiAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogI2Y4ZjlmYTsgcGFkZGluZzogMjBweDsgYm9yZGVyLXJhZGl1czogNXB4O1wiPlxyXG4gICAgICAgICAgICAgICAgICAgIDxoMiBzdHlsZT1cImNvbG9yOiAjMmMzZTUwO1wiPldlbGNvbWUgdG8gR3VhcmRpYW4gR3JvdmUhPC9oMj5cclxuICAgICAgICAgICAgICAgICAgICA8cD5IZWxsbyAke3JlcS51c2VyLm5hbWV9LDwvcD5cclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwiYmFja2dyb3VuZC1jb2xvcjogd2hpdGU7IHBhZGRpbmc6IDE1cHg7IGJvcmRlci1yYWRpdXM6IDVweDsgbWFyZ2luOiAxNXB4IDA7IGJvcmRlci1sZWZ0OiA0cHggc29saWQgIzM0OThkYjtcIj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPHA+WW91J3ZlIHN1Y2Nlc3NmdWxseSBjcmVhdGVkIGEgPHN0cm9uZz4ke3JvbGV9PC9zdHJvbmc+IGFjY291bnQgZm9yIDxzdHJvbmc+JHtuYW1lfTwvc3Ryb25nPi48L3A+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIDxwPkhlcmUgYXJlIHRoZSBsb2dpbiBkZXRhaWxzOjwvcD5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPHRhYmxlIHN0eWxlPVwid2lkdGg6IDEwMCU7IGJvcmRlci1jb2xsYXBzZTogY29sbGFwc2U7XCI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dHI+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPHRkIHN0eWxlPVwicGFkZGluZzogOHB4OyBib3JkZXItYm90dG9tOiAxcHggc29saWQgI2RkZDsgd2lkdGg6IDEyMHB4O1wiPjxzdHJvbmc+VXNlcm5hbWU6PC9zdHJvbmc+PC90ZD5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgc3R5bGU9XCJwYWRkaW5nOiA4cHg7IGJvcmRlci1ib3R0b206IDFweCBzb2xpZCAjZGRkO1wiPiR7bmFtZX08L3RkPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx0cj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgc3R5bGU9XCJwYWRkaW5nOiA4cHg7XCI+PHN0cm9uZz5UZW1wb3JhcnkgUGFzc3dvcmQ6PC9zdHJvbmc+PC90ZD5cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8dGQgc3R5bGU9XCJwYWRkaW5nOiA4cHg7XCI+JHtnZW5lcmF0ZWRQYXNzd29yZH08L3RkPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgPC90cj5cclxuICAgICAgICAgICAgICAgICAgICAgICAgPC90YWJsZT5cclxuICAgICAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICA8cCBzdHlsZT1cImNvbG9yOiAjZTc0YzNjOyBmb250LXdlaWdodDogYm9sZDtcIj5QbGVhc2UgY2hhbmdlIHRoaXMgcGFzc3dvcmQgYWZ0ZXIgZmlyc3QgbG9naW4uPC9wPlxyXG4gICAgICAgICAgICAgICAgICAgIFxyXG4gICAgICAgICAgICAgICAgICAgIDxwPklmIHlvdSBkaWRuJ3QgcmVxdWVzdCB0aGlzIGFjY291bnQgY3JlYXRpb24sIHBsZWFzZSBjb250YWN0IG91ciBzdXBwb3J0IGltbWVkaWF0ZWx5LjwvcD5cclxuICAgICAgICAgICAgICAgICAgICBcclxuICAgICAgICAgICAgICAgICAgICA8ZGl2IHN0eWxlPVwibWFyZ2luLXRvcDogMjBweDsgcGFkZGluZy10b3A6IDIwcHg7IGJvcmRlci10b3A6IDFweCBzb2xpZCAjZWVlO1wiPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8cD5CZXN0IHJlZ2FyZHMsPC9wPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8cD48c3Ryb25nPlRoZSBHdWFyZGlhbiBHcm92ZSBUZWFtPC9zdHJvbmc+PC9wPlxyXG4gICAgICAgICAgICAgICAgICAgICAgICA8cCBzdHlsZT1cImZvbnQtc2l6ZTogMTJweDsgY29sb3I6ICM3ZjhjOGQ7XCI+VGhpcyBpcyBhbiBhdXRvbWF0ZWQgbWVzc2FnZSAtIHBsZWFzZSBkbyBub3QgcmVwbHkgZGlyZWN0bHkgdG8gdGhpcyBlbWFpbC48L3A+XHJcbiAgICAgICAgICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgICAgICAgICA8L2Rpdj5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgYDtcclxuXHJcbiAgICAgICAgLy8gU2VuZCBlbWFpbCB3aXRoIHRoZSB0ZW1wb3JhcnkgcGFzc3dvcmRcclxuICAgICAgICBhd2FpdCBzZW5kTWFpbChmcm9tLCB0bywgc3ViamVjdCwgaHRtbCk7XHJcblxyXG4gICAgICAgIGF3YWl0IHVzZXIuc2F2ZSgpO1xyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgbWVzc2FnZTogXCJVc2VyIGNyZWF0ZWQgc3VjY2Vzc2Z1bGx5LCBwYXNzd29yZCBlbWFpbCBzZW50LlwiLCB1c2VyIH0pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICBpZiAoZXJyb3IgaW5zdGFuY2VvZiBFcnJvcikge1xyXG4gICAgICAgICAgICAvLyBIYW5kbGUgTW9uZ29EQiBkdXBsaWNhdGUga2V5IGVycm9yICgxMTAwMClcclxuICAgICAgICAgICAgaWYgKChlcnJvciBhcyBhbnkpLmNvZGUgPT09IDExMDAwKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IFxyXG4gICAgICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiQSB1c2VyIHdpdGggdGhpcyBuYW1lIGFuZCBlbWFpbCBhbHJlYWR5IGV4aXN0cy5cIiwgXHJcbiAgICAgICAgICAgICAgICAgICAgcmVzLCBcclxuICAgICAgICAgICAgICAgICAgICBzdGF0dXM6IDQwOSBcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBlcnJvci5tZXNzYWdlLCByZXMsIHN0YXR1czogNTAwIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkFuIHVua25vd24gZXJyb3Igb2NjdXJyZWQuXCIsIHJlcywgc3RhdHVzOiA1MDAgfSk7XHJcbiAgICAgICAgfSAgICBcclxuICAgIH0gXHJcbn07XHJcblxyXG4vLyBBUEkgdG8gZWRpdCB1c2VyIHByb2ZpbGVcclxuZXhwb3J0IGNvbnN0IGVkaXRVc2VyUHJvZmlsZSA9IGFzeW5jKHJlcTogQ3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6UHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnl7XHJcbiAgICAgICAgY29uc3Qge3VzZXJJZCwgbmFtZSwgYmlydGhkYXksIGdlbmRlciwgYXZhdGFyLCByb2xlfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICgocm9sZSkgJiYgIVsncGFyZW50JywgJ2FkbWluJywgJ293bmVyJ10uaW5jbHVkZXMocmVxLnVzZXIucm9sZSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZvcmJpZGRlbjogWW91IGNhbm5vdCBjaGFuZ2Ugcm9sZSBub3IgZW1haWxcIiwgcmVzLCBzdGF0dXM6IDQwMyB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB1c2VyO1xyXG5cclxuICAgICAgICBpZih1c2VySWQpe1xyXG4gICAgICAgICAgICBpZighY2hlY2tJZCh7aWQ6IHVzZXJJZCwgcmVzfSkpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKHJlcS51c2VyLl9pZC50b1N0cmluZygpICE9PSB1c2VySWQgJiYgIVsncGFyZW50JywgJ2FkbWluJywgJ293bmVyJ10uaW5jbHVkZXMocmVxLnVzZXIucm9sZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJGb3JiaWRkZW5cIiwgcmVzLCBzdGF0dXM6IDQwMyB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdXNlcil7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVXNlciBub3QgZm91bmRcIiwgcmVzLCBzdGF0dXM6IDQwNH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZihyZXEudXNlci5yb2xlICE9PSBcImFkbWluXCIgJiYgcmVxLnVzZXIuZW1haWwgIT09IHVzZXIuZW1haWwpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZvcmJpZGRlblwiLCByZXMsIHN0YXR1czogNDAzIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHVzZXIgPSByZXEudXNlcjtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIENoZWNrIGlmIGEgdXNlciB3aXRoIHRoZSBzYW1lIGVtYWlsIGFuZCBuYW1lIGV4aXN0c1xyXG4gICAgICAgIGlmIChuYW1lKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nVXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsOiB1c2VyLmVtYWlsLCBuYW1lLCBfaWQ6IHsgJG5lOiB1c2VyLl9pZCB9IH0pO1xyXG4gICAgICAgICAgICBpZiAoZXhpc3RpbmdVc2VyKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiQSB1c2VyIHdpdGggdGhlIHNhbWUgZW1haWwgYW5kIG5hbWUgYWxyZWFkeSBleGlzdHMuXCIsIHJlcywgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdXNlci5uYW1lID0gbmFtZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChuYW1lKSB1c2VyLm5hbWUgPSBuYW1lO1xyXG4gICAgICAgIGlmIChiaXJ0aGRheSkgdXNlci5iaXJ0aGRheSA9IGJpcnRoZGF5O1xyXG4gICAgICAgIGlmIChnZW5kZXIpIHVzZXIuZ2VuZGVyID0gZ2VuZGVyO1xyXG4gICAgICAgIGlmIChhdmF0YXIpIHVzZXIuYXZhdGFyID0gYXZhdGFyO1xyXG4gICAgICAgIGlmIChyb2xlKSB1c2VyLnJvbGUgPSByb2xlOyBcclxuXHJcbiAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHttZXNzYWdlOiBcIlVzZXIgcHJvZmlsZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseVwiLCB1c2VyfSk7XHJcbiAgICB9Y2F0Y2goZXJyb3Ipe1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJGYWlsZWQgdG8gdXBkYXRlLiBBbiB1bmtub3duIGVycm9yIG9jY3VycmVkLlwiLCByZXMsIHN0YXR1czogNTAwIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyBBUEkgdG8gZGVsZXRlIHVzZXJcclxuZXhwb3J0IGNvbnN0IGRlbGV0ZVVzZXIgPSBhc3luYyhyZXE6IEN1c3RvbVJlcXVlc3QsIHJlczpSZXNwb25zZSk6UHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnl7XHJcbiAgICAgICAgY29uc3Qge3VzZXJJZH0gPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkXCIsIHJlcywgc3RhdHVzOiA0MDEgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgdXNlcjtcclxuICAgICAgICBpZih1c2VySWQpe1xyXG4gICAgICAgICAgICBpZighY2hlY2tJZCh7aWQ6IHVzZXJJZCwgcmVzfSkpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKHJlcS51c2VyLl9pZC50b1N0cmluZygpICE9PSB1c2VySWQgJiYgIVsncGFyZW50JywgJ2FkbWluJywgJ293bmVyJ10uaW5jbHVkZXMocmVxLnVzZXIucm9sZSkpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJGb3JiaWRkZW5cIiwgcmVzLCBzdGF0dXM6IDQwMyB9KTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdXNlciA9IGF3YWl0IFVzZXIuZmluZEJ5SWQodXNlcklkKTtcclxuXHJcbiAgICAgICAgICAgIGlmICghdXNlcil7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVXNlciBub3QgZm91bmRcIiwgcmVzLCBzdGF0dXM6IDQwNH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICBpZihyZXEudXNlci5yb2xlICE9PSBcImFkbWluXCIgJiYgcmVxLnVzZXIuZW1haWwgIT09IHVzZXIuZW1haWwpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZvcmJpZGRlblwiLCByZXMsIHN0YXR1czogNDAzIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHVzZXIgPSByZXEudXNlcjtcclxuICAgICAgICB9XHJcblxyXG5cclxuICAgICAgICAvLyBQcmV2ZW50IGRlbGV0aW5nIHRoZSBsYXN0IHBhcmVudCBpbiBhIGZhbWlseVxyXG4gICAgICAgIGNvbnN0IGZhbWlseSA9IGF3YWl0IEZhbWlseS5maW5kQnlJZCh1c2VyLmZhbWlseUlkKTtcclxuICAgICAgICBpZiAoZmFtaWx5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudHNDb3VudCA9IGF3YWl0IFVzZXIuY291bnREb2N1bWVudHMoeyBmYW1pbHlJZDogZmFtaWx5Ll9pZCwgcm9sZTogJ3BhcmVudCcgfSk7XHJcbiAgICAgICAgICAgIGlmICh1c2VyLnJvbGUgPT09ICdwYXJlbnQnICYmIHBhcmVudHNDb3VudCA8PSAxKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiQ2Fubm90IGRlbGV0ZSB0aGUgbGFzdCBwYXJlbnQgaW4gdGhlIGZhbWlseVwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBSZW1vdmUgdXNlciBmcm9tIHRoZSBmYW1pbHkgbWVtYmVycyBsaXN0XHJcbiAgICAgICAgICAgIGZhbWlseS5tZW1iZXJzID0gZmFtaWx5Lm1lbWJlcnMuZmlsdGVyKChtZW1iZXIpID0+IG1lbWJlci5faWQudG9TdHJpbmcoKSAhPT0gdXNlci5faWQudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgIGF3YWl0IGZhbWlseS5zYXZlKCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBEZWxldGUgdGhlIHVzZXJcclxuICAgICAgICBhd2FpdCBVc2VyLmZpbmRCeUlkQW5kRGVsZXRlKHVzZXIuX2lkKTtcclxuICAgICAgXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe21lc3NhZ2U6IFwiVXNlciBkZWxldGVkIHN1Y2Nlc3NmdWxseVwiLCB1c2VyfSk7XHJcbiAgICB9Y2F0Y2goZXJyb3Ipe1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJGYWlsZWQgdG8gZGVsZXRlLiBBbiB1bmtub3duIGVycm9yIG9jY3VycmVkLlwiLCByZXMsIHN0YXR1czogNTAwIH0pO1xyXG4gICAgfVxyXG59IFxyXG5cclxuLy8gQVBJIHRvIHVwZGF0ZSBwYXNzd29yZFxyXG5leHBvcnQgY29uc3QgdXBkYXRlUGFzc3dvcmQgPSBhc3luYyAocmVxOiBDdXN0b21SZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHt1c2VySWQsIG9sZFBhc3N3b3JkLCBuZXdQYXNzd29yZCwgY29uZmlybVBhc3N3b3JkIH0gPSByZXEuYm9keTtcclxuICAgICAgICBcclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCB1c2VyO1xyXG5cclxuICAgICAgICBpZih1c2VySWQpe1xyXG4gICAgICAgICAgICBpZighY2hlY2tJZCh7aWQ6IHVzZXJJZCwgcmVzfSkpIHJldHVybjtcclxuICAgICAgICAgICAgaWYgKHJlcS51c2VyLl9pZC50b1N0cmluZygpICE9PSB1c2VySWQgJiYgcmVxLnVzZXIucm9sZSAhPT0gXCJhZG1pblwiKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRm9yYmlkZGVuXCIsIHJlcywgc3RhdHVzOiA0MDMgfSk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHVzZXIgPSBhd2FpdCBVc2VyLmZpbmRCeUlkKHVzZXJJZCk7XHJcblxyXG4gICAgICAgICAgICBpZiAoIXVzZXIpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIlVzZXIgbm90IGZvdW5kXCIsIHJlcywgc3RhdHVzOiA0MDR9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICB1c2VyID0gcmVxLnVzZXI7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBWYWxpZGF0ZSByZXF1aXJlZCBmaWVsZHNcclxuICAgICAgICBpZiAoIW9sZFBhc3N3b3JkIHx8ICFuZXdQYXNzd29yZCB8fCAhY29uZmlybVBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBbGwgZmllbGRzIGFyZSByZXF1aXJlZC5cIiwgcmVzLCBzdGF0dXM6IDQwMCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChuZXdQYXNzd29yZCAhPT0gY29uZmlybVBhc3N3b3JkKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJQYXNzd29yZHMgZG8gbm90IG1hdGNoLlwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVmVyaWZ5IG9sZCBwYXNzd29yZFxyXG4gICAgICAgIGNvbnN0IGlzTWF0Y2ggPSBhd2FpdCBiY3J5cHQuY29tcGFyZShvbGRQYXNzd29yZCwgdXNlci5wYXNzd29yZCk7XHJcbiAgICAgICAgaWYgKCFpc01hdGNoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJPbGQgcGFzc3dvcmQgaXMgaW5jb3JyZWN0LlwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgdGhlIG5ldyBwYXNzd29yZCBpcyBkaWZmZXJlbnQgZnJvbSB0aGUgb2xkIG9uZVxyXG4gICAgICAgIGNvbnN0IGlzU2FtZVBhc3N3b3JkID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUobmV3UGFzc3dvcmQsIHJlcS51c2VyLnBhc3N3b3JkKTtcclxuICAgICAgICBpZiAoaXNTYW1lUGFzc3dvcmQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIk5ldyBwYXNzd29yZCBjYW5ub3QgYmUgdGhlIHNhbWUgYXMgdGhlIG9sZCBwYXNzd29yZC5cIiwgcmVzLCBzdGF0dXM6IDQwMCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHBhc3N3b3JkUmVnZXggPSAvXig/PS4qW2Etel0pKD89LipbQS1aXSkoPz0uKlxcZCkoPz0uKltAJCElKj8mXSlbQS1aYS16XFxkQCQhJSo/Jl17OCx9JC87XHJcbiAgICAgICAgaWYgKCFwYXNzd29yZFJlZ2V4LnRlc3QobmV3UGFzc3dvcmQpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHtcclxuICAgICAgICAgICAgICAgIG1lc3NhZ2U6IFwiUGFzc3dvcmQgbXVzdCBiZSBhdCBsZWFzdCA4IGNoYXJhY3RlcnMgbG9uZywgaW5jbHVkZSBhbiB1cHBlcmNhc2UgbGV0dGVyLCBsb3dlcmNhc2UgbGV0dGVyLCBhIG51bWJlciwgYW5kIGEgc3BlY2lhbCBjaGFyYWN0ZXIuXCIsXHJcbiAgICAgICAgICAgICAgICByZXMsXHJcbiAgICAgICAgICAgICAgICBzdGF0dXM6IDQwMFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEhhc2ggbmV3IHBhc3N3b3JkXHJcbiAgICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChuZXdQYXNzd29yZCwgMTApO1xyXG4gICAgICAgIHVzZXIucGFzc3dvcmQgPSBoYXNoZWRQYXNzd29yZDtcclxuICAgICAgICB1c2VyLmlzVGVtcFBhc3N3b3JkID0gZmFsc2U7XHJcbiAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XHJcblxyXG4gICAgICAgIC8vIFJldHVybiBzdWNjZXNzIHJlc3BvbnNlXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoeyBtZXNzYWdlOiBcIlBhc3N3b3JkIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5LlwiLCBwYXNzd29yZDogbmV3UGFzc3dvcmQgfSk7XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRmFpbGVkIHRvIHVwZGF0ZSBwYXNzd29yZC5cIiwgcmVzLCBzdGF0dXM6IDUwMCB9KTtcclxuICAgIH1cclxufTtcclxuXHJcbi8vIEFQSSB0byBnZXQgdXNlcidzIHN0YXJzXHJcbmV4cG9ydCBjb25zdCBnZXRVc2VyU3RhcnMgPSBhc3luYyhyZXE6Q3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIlVuYXV0aG9yaXplZFwiLCByZXMsIHN0YXR1czogNDAxfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7bWVzc2FnZTpcIlN0YXJzIHJldHJpZXZlZCBzdWNjZXNzZnVsbHlcIiwgc3RhcnM6IHJlcS51c2VyLnN0YXJzfSk7XHJcblxyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgcmV0cmlldmluZyB1c2VyIHN0YXJzXCIsIHJlcywgc3RhdHVzOiA1MDB9KTtcclxuICAgIH1cclxufSBcclxuXHJcbi8vIEFQSSB0byB1cGRhdGUgdXNlcidzIHN0YXJzXHJcbmV4cG9ydCBjb25zdCB1cGRhdGVVc2VyU3RhcnMgPSBhc3luYyhyZXE6Q3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGNvbnN0IHsgc3RhcnMgfTogeyBzdGFyczogbnVtYmVyIH0gPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkXCIsIHJlcywgc3RhdHVzOiA0MDF9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChzdGFycyA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBzdGFycyAhPT0gXCJudW1iZXJcIiB8fCBzdGFycyA8IDApe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiU3RhcnMgbXVzdCBiZSBhIHZhbGlkIG51bWJlci5cIiwgcmVzLCBzdGF0dXM6IDQwMH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVxLnVzZXIuc3RhcnMgKz0gc3RhcnM7XHJcbiAgICAgICAgYXdhaXQgcmVxLnVzZXIuc2F2ZSgpO1xyXG5cclxuICAgICAgICBpZighcmVxLnVzZXIuZmFtaWx5SWQpe1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiTm8gZmFtaWx5IGlkXCIsIHJlcywgc3RhdHVzOiA0MDB9KTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXdhaXQgRmFtaWx5LmZpbmRCeUlkQW5kVXBkYXRlKHJlcS51c2VyLmZhbWlseUlkLCB7ICRpbmM6IHsgdG90YWxTdGFyczogc3RhcnMgfSB9KTtcclxuICAgICAgICBcclxuICAgICAgICBhd2FpdCByZWNhbGN1bGF0ZUZhbWlseU1lbWJlclJhbmtzKHJlcS51c2VyLmZhbWlseUlkLCByZXEudXNlcik7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgbWVzc2FnZTogXCJVc2VyIHN0YXJzIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCIsIHVzZXI6IHJlcS51c2VyIH0pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgdXBkYXRpbmcgdXNlciBzdGFyc1wiLCByZXMsIHN0YXR1czogNTAwfSk7XHJcbiAgICB9XHJcbn0gXHJcblxyXG4vLyBBUEkgdG8gZ2V0IHVzZXIncyBjb2luc1xyXG5leHBvcnQgY29uc3QgZ2V0VXNlckNvaW5zID0gYXN5bmMocmVxOkN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe21lc3NhZ2U6XCJDb2lucyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCIsIGNvaW5zOiByZXEudXNlci5jb2luc30pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgcmV0cmlldmluZyB1c2VyIGNvaW5zXCIsIHJlcywgc3RhdHVzOiA1MDB9KTtcclxuICAgIH1cclxufSBcclxuXHJcbi8vIEFQSSB0byB1cGRhdGUgdXNlcidzIGNvaW5zXHJcbmV4cG9ydCBjb25zdCB1cGRhdGVVc2VyQ29pbnMgPSBhc3luYyhyZXE6Q3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGNvbnN0IHsgY29pbnMgfTogeyBjb2luczogbnVtYmVyIH0gPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkXCIsIHJlcywgc3RhdHVzOiA0MDF9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmIChjb2lucyA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBjb2lucyAhPT0gXCJudW1iZXJcIil7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJTdGFycyBtdXN0IGJlIGEgdmFsaWQgbnVtYmVyLlwiLCByZXMsIHN0YXR1czogNDAwfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEudXNlci5jb2lucyArPSBjb2lucztcclxuICAgICAgICBhd2FpdCByZXEudXNlci5zYXZlKCk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgbWVzc2FnZTogXCJVc2VyIGNvaW5zIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCIsIHVzZXI6IHJlcS51c2VyIH0pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgdXBkYXRpbmcgdXNlciBjb2luc1wiLCByZXMsIHN0YXR1czogNTAwfSk7XHJcbiAgICB9XHJcbn0gXHJcblxyXG5cclxuLy8gQVBJIHRvIGdldCB1c2VyJ3MgbG9jYXRpb25cclxuZXhwb3J0IGNvbnN0IGdldExvY2F0aW9uID0gYXN5bmMocmVxOkN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe21lc3NhZ2U6XCJMb2NhdGlvbiByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCIsIGxvY2F0aW9uOiByZXEudXNlci5jdXJyZW50TG9jYXRpb259KTtcclxuXHJcbiAgICB9Y2F0Y2goZXJyb3Ipe1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJFcnJvciByZXRyaWV2aW5nIHVzZXIgbG9jYXRpb25cIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59IFxyXG5cclxuLy8gQVBJIHRvIHVwZGF0ZSB1c2VyJ3MgY3VycmVudCBsb2NhdGlvblxyXG5leHBvcnQgY29uc3QgdXBkYXRlTG9jYXRpb24gPSBhc3luYyhyZXE6Q3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGNvbnN0IHsgY3VycmVudExvY2F0aW9uIH06IHsgY3VycmVudExvY2F0aW9uOiBzdHJpbmcgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHR5cGVvZiBjdXJyZW50TG9jYXRpb24gIT09IFwic3RyaW5nXCIgfHwgY3VycmVudExvY2F0aW9uLnRyaW0oKSA9PT0gXCJcIil7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJMb2NhdGlvbiBtdXN0IGJlIHZhbGlkLlwiLCByZXMsIHN0YXR1czogNDAwfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXEudXNlci5jdXJyZW50TG9jYXRpb24gPSBjdXJyZW50TG9jYXRpb247XHJcbiAgICAgICAgYXdhaXQgcmVxLnVzZXIuc2F2ZSgpO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7IG1lc3NhZ2U6IFwiVXNlciBsb2NhdGlvbiB1cGRhdGVkIHN1Y2Nlc3NmdWxseVwiLCB1c2VyOiByZXEudXNlciB9KTtcclxuICAgIH1jYXRjaChlcnJvcil7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkVycm9yIHVwZGF0aW5nIHVzZXIgbG9jYXRpb25cIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59ICBcclxuXHJcbi8vIEFQSSB0byBnZXQgdXNlcidzIHJhbmtcclxuZXhwb3J0IGNvbnN0IGdldFVzZXJSYW5rID0gYXN5bmMocmVxOkN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe21lc3NhZ2U6XCJSYW5rIHJldHJpZXZlZCBzdWNjZXNzZnVsbHlcIiwgUmFuazogcmVxLnVzZXIucmFua0luRmFtaWx5fSk7XHJcbiAgICB9Y2F0Y2goZXJyb3Ipe1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJFcnJvciByZXRyaWV2aW5nIHVzZXIgcmFua1wiLCByZXMsIHN0YXR1czogNTAwfSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG4vLyBBUEkgdG8gdXBkYXRlIHVzZXIncyByYW5rXHJcbi8qZXhwb3J0IGNvbnN0IHVwZGF0ZVVzZXJSYW5rID0gYXN5bmMocmVxOkN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBjb25zdCB7IHJhbmsgfTogeyByYW5rOiBudW1iZXIgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHJhbmsgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2YgcmFuayAhPT0gXCJudW1iZXJcIil7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJSYW5rIG11c3QgYmUgYSB2YWxpZCBudW1iZXIuXCIsIHJlcywgc3RhdHVzOiA0MDB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlcS51c2VyLnJhbmtJbkZhbWlseSA9IHJhbms7XHJcbiAgICAgICAgYXdhaXQgcmVxLnVzZXIuc2F2ZSgpO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuc2VuZCh7IG1lc3NhZ2U6IFwiVXNlciByYW5rIHVwZGF0ZWQgc3VjY2Vzc2Z1bGx5XCIsIHVzZXI6IHJlcS51c2VyIH0pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgdXBkYXRpbmcgdXNlciByYW5rXCIsIHJlcywgc3RhdHVzOiA1MDB9KTtcclxuICAgIH1cclxufTsqL1xyXG5cclxuLy8gQVBJIHRvIGdldCB1c2VyJ3MgaW50ZXJlc2V0c1xyXG5leHBvcnQgY29uc3QgZ2V0VXNlckludGVyZXN0cyA9IGFzeW5jKHJlcTpDdXN0b21SZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnl7XHJcbiAgICAgICAgaWYgKCFyZXEudXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVW5hdXRob3JpemVkXCIsIHJlcywgc3RhdHVzOiA0MDF9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgbWVzc2FnZTogXCJJbnRlcmVzdHMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseVwiLCBJbnRlcmVzdHM6IHJlcS51c2VyLmludGVyZXN0c30pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJFcnJvciByZXRyaWV2aW5nIHVzZXIgaW50ZXJlc3RzXCIsIHJlcywgc3RhdHVzOiA1MDB9KTtcclxuICAgIH1cclxufTtcclxuXHJcbi8vIEFQSSB0byBzdGFydCBhbiBhZHZlbnR1cmVcclxuZXhwb3J0IGNvbnN0IHN0YXJ0QWR2ZW50dXJlID0gYXN5bmMgKHJlcTogQ3VzdG9tUmVxdWVzdCwgcmVzOiBSZXNwb25zZSk6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5IHtcclxuICAgICAgICBjb25zdCB7YWR2ZW50dXJlSWR9ID0gcmVxLmJvZHk7XHJcblxyXG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIlVuYXV0aG9yaXplZFwiLCByZXMsIHN0YXR1czogNDAxIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdXNlcklkID0gcmVxLnVzZXIuX2lkO1xyXG5cclxuICAgICAgICBpZighY2hlY2tJZCh7aWQ6IGFkdmVudHVyZUlkLCByZXN9KSkgcmV0dXJuO1xyXG4gICAgICAgIGlmKCFjaGVja0lkKHtpZDogdXNlcklkLnRvU3RyaW5nKCksIHJlc30pKSByZXR1cm47XHJcblxyXG4gICAgICAgIC8vIEZpbmQgdGhlIGFkdmVudHVyZSBieSBhZHZlbnR1cmVJZFxyXG4gICAgICAgIGNvbnN0IGFkdmVudHVyZSA9IGF3YWl0IEFkdmVudHVyZS5maW5kQnlJZChhZHZlbnR1cmVJZCk7XHJcbiAgICAgICAgaWYgKCFhZHZlbnR1cmUpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkFkdmVudHVyZSBub3QgZm91bmRcIiwgcmVzLCBzdGF0dXM6IDQwNCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nQWR2ZW50dXJlUHJvZ3Jlc3MgPSByZXEudXNlci5hZHZlbnR1cmVzLmZpbmQoXHJcbiAgICAgICAgICAgIChhZHZlbnR1cmVQcm9ncmVzcykgPT4gXHJcbiAgICAgICAgICAgICAgICBhZHZlbnR1cmVQcm9ncmVzcy5hZHZlbnR1cmVJZC5lcXVhbHMoYWR2ZW50dXJlSWQpXHJcbiAgICAgICAgKTtcclxuICAgICAgICBpZiAoZXhpc3RpbmdBZHZlbnR1cmVQcm9ncmVzcykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiQWR2ZW50dXJlIGFscmVhZHkgc3RhcnRlZFwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQWRkIGFkdmVudHVyZSB0byB1c2VyJ3MgYWR2ZW50dXJlc1xyXG4gICAgICAgIGNvbnN0IG5ld0FkdmVudHVyZVByb2dyZXNzIDogSUFkdmVudHVyZVByb2dyZXNzID0ge1xyXG4gICAgICAgICAgICBhZHZlbnR1cmVJZDogYWR2ZW50dXJlSWQsXHJcbiAgICAgICAgICAgIGNoYWxsZW5nZXM6IGFkdmVudHVyZS5jaGFsbGVuZ2VzLm1hcCgoY2hhbGxlbmdlKSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgY2hhbGxlbmdlSWQ6IGNoYWxsZW5nZS5faWQsXHJcbiAgICAgICAgICAgICAgICBpc0NvbXBsZXRlZDogZmFsc2UsICBcclxuICAgICAgICAgICAgfSkpLFxyXG4gICAgICAgICAgICBzdGF0dXM6IFwiaW4tcHJvZ3Jlc3NcIixcclxuICAgICAgICAgICAgaXNBZHZlbnR1cmVDb21wbGV0ZWQ6IGZhbHNlLFxyXG4gICAgICAgICAgICBzdGFyc1Jld2FyZDogYWR2ZW50dXJlLnN0YXJzUmV3YXJkLFxyXG4gICAgICAgICAgICBjb2luc1Jld2FyZDogYWR2ZW50dXJlLmNvaW5zUmV3YXJkLFxyXG4gICAgICAgICAgICBwcm9ncmVzczogMCxcclxuICAgICAgICB9O1xyXG5cclxuICAgICAgICByZXEudXNlci5hZHZlbnR1cmVzLnB1c2gobmV3QWR2ZW50dXJlUHJvZ3Jlc3MpO1xyXG4gICAgICAgIGF3YWl0IHJlcS51c2VyLnNhdmUoKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoeyBtZXNzYWdlOiBcIkFkdmVudHVyZSBzdGFydGVkIHN1Y2Nlc3NmdWxseVwiLCB1c2VyOiByZXEudXNlciB9KTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBbiB1bmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIHN0YXJ0aW5nIHRoZSBhZHZlbnR1cmUuXCIsIHJlcywgc3RhdHVzOiA1MDAgfSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG5leHBvcnQgY29uc3QgY29tcGxldGVDaGFsbGVuZ2UgPSBhc3luYyAocmVxOiBDdXN0b21SZXF1ZXN0LCByZXM6IFJlc3BvbnNlKTogUHJvbWlzZTx2b2lkPiA9PiB7XHJcbiAgICB0cnkge1xyXG4gICAgICAgIGNvbnN0IHsgYWR2ZW50dXJlSWQsIGNoYWxsZW5nZUlkIH0gPSByZXEuYm9keTtcclxuXHJcbiAgICAgICAgaWYgKCFjaGVja0lkKHsgaWQ6IGFkdmVudHVyZUlkLCByZXMgfSkpIHJldHVybjtcclxuICAgICAgICBpZiAoIWNoZWNrSWQoeyBpZDogY2hhbGxlbmdlSWQsIHJlcyB9KSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHVzZXIgPSByZXEudXNlcjtcclxuICAgICAgICBjb25zdCBhZHZlbnR1cmVQcm9ncmVzcyA9IHVzZXIuYWR2ZW50dXJlcy5maW5kKFxyXG4gICAgICAgICAgICAoYWR2ZW50dXJlKSA9PiBhZHZlbnR1cmUuYWR2ZW50dXJlSWQuZXF1YWxzKGFkdmVudHVyZUlkKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaWYgKCFhZHZlbnR1cmVQcm9ncmVzcykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiQWR2ZW50dXJlIG5vdCBmb3VuZCBpbiB1c2VyJ3MgcHJvZmlsZVwiLCByZXMsIHN0YXR1czogNDA0IH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgY2hhbGxlbmdlID0gYWR2ZW50dXJlUHJvZ3Jlc3MuY2hhbGxlbmdlcy5maW5kKFxyXG4gICAgICAgICAgICAoY2hhbGxlbmdlKSA9PiBjaGFsbGVuZ2UuY2hhbGxlbmdlSWQuZXF1YWxzKGNoYWxsZW5nZUlkKVxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaWYgKCFjaGFsbGVuZ2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkNoYWxsZW5nZSBub3QgZm91bmQgaW4gYWR2ZW50dXJlXCIsIHJlcywgc3RhdHVzOiA0MDQgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBGZXRjaCB0aGUgZnVsbCBhZHZlbnR1cmUgdG8gZ2V0IGNoYWxsZW5nZSByZXdhcmRzXHJcbiAgICAgICAgY29uc3QgYWR2ZW50dXJlID0gYXdhaXQgQWR2ZW50dXJlLmZpbmRCeUlkKGFkdmVudHVyZUlkKS5sZWFuKCk7XHJcblxyXG4gICAgICAgIGlmICghYWR2ZW50dXJlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBZHZlbnR1cmUgbm90IGZvdW5kXCIsIHJlcywgc3RhdHVzOiA0MDQgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0YXJnZXRDaGFsbGVuZ2UgPSBhZHZlbnR1cmUuY2hhbGxlbmdlcy5maW5kKGNoID0+XHJcbiAgICAgICAgICAgIGNoLl9pZC5lcXVhbHMoY2hhbGxlbmdlSWQpXHJcbiAgICAgICAgKTtcclxuXHJcbiAgICAgICAgaWYgKCF0YXJnZXRDaGFsbGVuZ2UpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkNoYWxsZW5nZSBkYXRhIG5vdCBmb3VuZCBpbiBhZHZlbnR1cmVcIiwgcmVzLCBzdGF0dXM6IDQwNCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIE1hcmsgY2hhbGxlbmdlIGFzIGNvbXBsZXRlIGFuZCBhZGQgcmV3YXJkc1xyXG4gICAgICAgIGNoYWxsZW5nZS5pc0NvbXBsZXRlZCA9IHRydWU7XHJcbiAgICAgICAgY2hhbGxlbmdlLmNvbXBsZXRlZEF0ID0gbmV3IERhdGUoKTtcclxuXHJcbiAgICAgICAgY29uc3Qgc3RhcnNSZXdhcmQgPSB0YXJnZXRDaGFsbGVuZ2Uuc3RhcnNSZXdhcmQ7XHJcbiAgICAgICAgY29uc3QgY29pbnNSZXdhcmQgPSB0YXJnZXRDaGFsbGVuZ2UuY29pbnNSZXdhcmQ7XHJcblxyXG4gICAgICAgIHVzZXIuc3RhcnMgKz0gc3RhcnNSZXdhcmQ7XHJcbiAgICAgICAgdXNlci5jb2lucyArPSBjb2luc1Jld2FyZDtcclxuXHJcbiAgICAgICAgYWR2ZW50dXJlUHJvZ3Jlc3MucHJvZ3Jlc3MgPSAoYWR2ZW50dXJlUHJvZ3Jlc3MuY2hhbGxlbmdlcy5maWx0ZXIoY2hhbGxlbmdlID0+IGNoYWxsZW5nZS5pc0NvbXBsZXRlZCkubGVuZ3RoIC8gYWR2ZW50dXJlUHJvZ3Jlc3MuY2hhbGxlbmdlcy5sZW5ndGgpICogMTAwO1xyXG5cclxuICAgICAgICBsZXQgYWR2ZW50dXJlU3RhcnMgPSAwO1xyXG4gICAgICAgIGlmIChhZHZlbnR1cmVQcm9ncmVzcy5wcm9ncmVzcyA9PT0gMTAwKSB7XHJcbiAgICAgICAgICAgIGFkdmVudHVyZVByb2dyZXNzLmlzQWR2ZW50dXJlQ29tcGxldGVkID0gdHJ1ZTtcclxuICAgICAgICAgICAgYWR2ZW50dXJlUHJvZ3Jlc3Muc3RhdHVzID0gJ2NvbXBsZXRlZCc7XHJcbiAgICAgICAgICAgIGFkdmVudHVyZVN0YXJzID0gYWR2ZW50dXJlUHJvZ3Jlc3Muc3RhcnNSZXdhcmQ7XHJcblxyXG4gICAgICAgICAgICB1c2VyLmNvaW5zICs9IGFkdmVudHVyZVByb2dyZXNzLmNvaW5zUmV3YXJkO1xyXG4gICAgICAgICAgICB1c2VyLnN0YXJzICs9IGFkdmVudHVyZVN0YXJzO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gVXBkYXRlIHRoZSBmYW1pbHkgdG90YWwgc3RhcnNcclxuICAgICAgICBpZiAodXNlci5mYW1pbHlJZCkge1xyXG4gICAgICAgICAgICBjb25zdCB0b3RhbFN0YXJzID0gc3RhcnNSZXdhcmQgKyBhZHZlbnR1cmVTdGFycztcclxuICAgICAgICAgICAgYXdhaXQgRmFtaWx5LmZpbmRCeUlkQW5kVXBkYXRlKHVzZXIuZmFtaWx5SWQsIHtcclxuICAgICAgICAgICAgICAgICRpbmM6IHsgdG90YWxTdGFyczogdG90YWxTdGFycyB9XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBhd2FpdCByZWNhbGN1bGF0ZUZhbWlseU1lbWJlclJhbmtzKHVzZXIuZmFtaWx5SWQsIHVzZXIpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgYXdhaXQgdXNlci5zYXZlKCk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgbWVzc2FnZTogXCJDaGFsbGVuZ2UgY29tcGxldGVkIHN1Y2Nlc3NmdWxseVwiLCBhZHZlbnR1cmVQcm9ncmVzcyB9KTtcclxuXHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBbiB1bmtub3duIGVycm9yIG9jY3VycmVkIHdoaWxlIGNvbXBsZXRpbmcgdGhlIGNoYWxsZW5nZS5cIiwgcmVzLCBzdGF0dXM6IDUwMCB9KTtcclxuICAgIH1cclxufTtcclxuXHJcbi8vIEFQSSB0byBnZXQgdXNlcidzIGFkdmVudHVyZXNcclxuZXhwb3J0IGNvbnN0IGdldFVzZXJBZHZlbnR1cmVzID0gYXN5bmMocmVxOkN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeXtcclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMX0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoeyBtZXNzYWdlOiBcIlVzZXIgYWR2ZW50dXJlcyByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCIsIEFkdmVudHVyZTogcmVxLnVzZXIuYWR2ZW50dXJlc30pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3IgcmV0cmlldmluZyB1c2VyIGFkdmVudHVyZXNcIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59O1xyXG5cclxuLy9BUEkgdG8gZ2V0IHVzZXIncyBwdXJjaGFzZWQgaXRlbXNcclxuZXhwb3J0IGNvbnN0IGdldFVzZXJQdXJjaGFzZWRJdGVtcyA9IGFzeW5jIChyZXE6IEN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgeyB1c2VySWQgfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIXJlcS51c2VyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJVbmF1dGhvcml6ZWRcIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHRhcmdldFVzZXJJZCA9IHVzZXJJZCB8fCByZXEudXNlci5faWQ7XHJcblxyXG4gICAgICAgIGlmICghY2hlY2tJZCh7IGlkOiB0YXJnZXRVc2VySWQsIHJlcyB9KSkgcmV0dXJuO1xyXG5cclxuICAgICAgICBjb25zdCBpc0F1dGhvcml6ZWQgPSByZXEudXNlci5faWQudG9TdHJpbmcoKSA9PT0gdGFyZ2V0VXNlcklkLnRvU3RyaW5nKCk7XHJcbiAgICAgICAgaWYgKCFpc0F1dGhvcml6ZWQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkZvcmJpZGRlblwiLCByZXMsIHN0YXR1czogNDAzIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gRmV0Y2ggb25seSBpdGVtSWRzIGZyb20gcHVyY2hhc2VkSXRlbXNcclxuICAgICAgICBjb25zdCB1c2VyID0gYXdhaXQgVXNlci5maW5kQnlJZCh0YXJnZXRVc2VySWQpLnNlbGVjdCgncHVyY2hhc2VkSXRlbXMuaXRlbUlkJyk7XHJcblxyXG4gICAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiVXNlciBub3QgZm91bmRcIiwgcmVzLCBzdGF0dXM6IDQwNCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNvbnN0IHB1cmNoYXNlZEl0ZW1JZHMgPSB1c2VyLnB1cmNoYXNlZEl0ZW1zLm1hcCgoaXRlbTogYW55KSA9PiBpdGVtLml0ZW1JZCk7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHsgbWVzc2FnZTogXCJQdXJjaGFzZWQgaXRlbXMgcmV0cmlldmVkIHN1Y2Nlc3NmdWxseVwiLCBwdXJjaGFzZWRJdGVtczogcHVyY2hhc2VkSXRlbUlkcyB9KTtcclxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XHJcbiAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkVycm9yIHJldHJpZXZpbmcgcHVyY2hhc2VkIGl0ZW1zXCIsIHJlcywgc3RhdHVzOiA1MDAgfSk7XHJcbiAgICB9XHJcbn07XHJcblxyXG4vL0FQSSB0byBnZXQgdXNlcidzIGF2YXRhclxyXG5leHBvcnQgY29uc3QgZ2V0VXNlckF2YXRhciA9IGFzeW5jIChyZXE6IEN1c3RvbVJlcXVlc3QsIHJlczogUmVzcG9uc2UpID0+IHtcclxuICAgIHRyeSB7XHJcblxyXG4gICAgICAgIGlmICghcmVxLnVzZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIlVuYXV0aG9yaXplZFwiLCByZXMsIHN0YXR1czogNDAxfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB1c2VyID0gcmVxLnVzZXI7XHJcblxyXG4gICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHttZXNzYWdlOiBcIkF2YXRhciByZXRyaWV2ZWQgc3VjY2Vzc2Z1bGx5XCIsIGF2YXRhcjogdXNlci5hdmF0YXIgfSk7XHJcbiAgICB9IGNhdGNoIChlcnJvcikge1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJFcnJvciBmZXRjaGluZyBhdmF0YXJcIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59OyJdLCJ2ZXJzaW9uIjozfQ==