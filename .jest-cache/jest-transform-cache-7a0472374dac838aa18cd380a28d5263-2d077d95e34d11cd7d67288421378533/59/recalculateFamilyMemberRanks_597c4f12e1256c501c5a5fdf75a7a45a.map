{"version":3,"sources":["C:\\Users\\USER\\Desktop\\guardian-grove\\guardian-grove-backend\\src\\utils\\recalculateFamilyMemberRanks.ts"],"sourcesContent":["import { Types } from \"mongoose\";\r\nimport { User } from \"../models/user.model\";\r\nimport { IUser } from \"../interfaces/IUser\";\r\n\r\n// Helper function to recalculate ranks within the family\r\nexport const recalculateFamilyMemberRanks = async (familyId: Types.ObjectId, updatedUser: IUser): Promise<void> => {\r\n    try {\r\n        const familyMembers = await User.find({ familyId })\r\n            .sort({ stars: -1, nbOfTasksCompleted: -1 })\r\n            .exec();\r\n\r\n        let rank = 0;\r\n        let prevStars = 0;\r\n        let prevTasks = 0;\r\n\r\n        const savePromises = familyMembers.map((member, index) => {\r\n            if (prevStars !== member.stars || prevTasks !== member.nbOfTasksCompleted) {\r\n                rank++;\r\n            }\r\n\r\n            member.rankInFamily = rank;\r\n            \r\n            // Update req.user directly if it's the same member\r\n            if (updatedUser._id.equals(member._id)) {\r\n                updatedUser.rankInFamily = rank;\r\n            }\r\n\r\n            prevStars = member.stars;\r\n            prevTasks = member.nbOfTasksCompleted;\r\n\r\n            return member.save();  // Save all members\r\n        });\r\n\r\n        await Promise.all(savePromises);  // Save all members in parallel\r\n    } catch (error) {\r\n        console.error(\"Error recalculating ranks:\", error);\r\n    }\r\n};"],"names":["recalculateFamilyMemberRanks","familyId","updatedUser","familyMembers","User","find","sort","stars","nbOfTasksCompleted","exec","rank","prevStars","prevTasks","savePromises","map","member","index","rankInFamily","_id","equals","save","Promise","all","error","console"],"mappings":";;;;+BAKaA;;;eAAAA;;;2BAJQ;AAId,MAAMA,+BAA+B,OAAOC,UAA0BC;IACzE,IAAI;QACA,MAAMC,gBAAgB,MAAMC,eAAI,CAACC,IAAI,CAAC;YAAEJ;QAAS,GAC5CK,IAAI,CAAC;YAAEC,OAAO,CAAC;YAAGC,oBAAoB,CAAC;QAAE,GACzCC,IAAI;QAET,IAAIC,OAAO;QACX,IAAIC,YAAY;QAChB,IAAIC,YAAY;QAEhB,MAAMC,eAAeV,cAAcW,GAAG,CAAC,CAACC,QAAQC;YAC5C,IAAIL,cAAcI,OAAOR,KAAK,IAAIK,cAAcG,OAAOP,kBAAkB,EAAE;gBACvEE;YACJ;YAEAK,OAAOE,YAAY,GAAGP;YAEtB,mDAAmD;YACnD,IAAIR,YAAYgB,GAAG,CAACC,MAAM,CAACJ,OAAOG,GAAG,GAAG;gBACpChB,YAAYe,YAAY,GAAGP;YAC/B;YAEAC,YAAYI,OAAOR,KAAK;YACxBK,YAAYG,OAAOP,kBAAkB;YAErC,OAAOO,OAAOK,IAAI,IAAK,mBAAmB;QAC9C;QAEA,MAAMC,QAAQC,GAAG,CAACT,eAAgB,+BAA+B;IACrE,EAAE,OAAOU,OAAO;QACZC,QAAQD,KAAK,CAAC,8BAA8BA;IAChD;AACJ"}