2dd274b4980ce908b9205adc96065bc8
"use strict";
var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.forgetPassword = exports.register = exports.login = void 0;
const bcrypt_1 = __importDefault(require("bcrypt"));
const error_1 = require("../utils/error");
const user_model_1 = require("../models/user.model");
const dotenv_1 = __importDefault(require("dotenv"));
const jsonwebtoken_1 = __importDefault(require("jsonwebtoken"));
const family_model_1 = require("../models/family.model");
const generateSecurePassword_1 = require("../utils/generateSecurePassword");
const email_service_1 = require("../services/email.service");
dotenv_1.default.config();
const JWT_SECRET_KEY = process.env.JWT_SECRET;
// login
const login = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { name, email, password } = req.body;
        if (!name || !email || !password) {
            return (0, error_1.throwError)({ message: "Name, email, and password are required.", res, status: 400 });
        }
        const user = yield user_model_1.User.findOne({
            name: name,
            email: email,
        });
        if (!user) {
            return (0, error_1.throwError)({ message: "Invalid credentials. User not found.", res, status: 404 });
        }
        // Verify password
        const isMatch = yield bcrypt_1.default.compare(password, user.password);
        if (!isMatch) {
            return (0, error_1.throwError)({ message: "Invalid password.", res, status: 401 });
        }
        if (!JWT_SECRET_KEY) {
            return (0, error_1.throwError)({ message: "JWT_SECRET_KEY is not defined", res, status: 500 });
        }
        const token = yield jsonwebtoken_1.default.sign({ userId: user.id, role: user.role }, JWT_SECRET_KEY);
        res.status(200).json({
            user: user,
            token,
            requiresPasswordChange: user.isTempPassword || false,
            message: user.isTempPassword
                ? 'Please set a new password'
                : 'Login successful'
        });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Something went wrong while logging in.", res, status: 500 });
    }
});
exports.login = login;
// register
const register = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const data = req.body;
        const { name, email, password, confirmPassword, birthday, gender, role, avatar, interests, familyName, familyAvatar } = data;
        // verify all fields are filled
        if (!name || !email || !password || !confirmPassword || !birthday || !gender || !role || !avatar || !interests || !familyName || !familyAvatar) {
            return (0, error_1.throwError)({ message: "All required fields must be filled.", res, status: 400 });
        }
        if (password !== confirmPassword) {
            return (0, error_1.throwError)({ message: "Passwords do not match", res, status: 400 });
        }
        // Email Validation
        const emailRegex = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
        if (!emailRegex.test(email)) {
            return (0, error_1.throwError)({ message: "Invalid email format.", res, status: 400 });
        }
        // Role validation
        const validRoles = ['parent', 'admin'];
        if (!validRoles.includes(role)) {
            if (role === "child") {
                return (0, error_1.throwError)({ message: "Children must be added by a parent.", res, status: 400 });
            }
            return (0, error_1.throwError)({ message: "Invalid role.", res, status: 400 });
        }
        if (!Array.isArray(interests)) {
            return (0, error_1.throwError)({ message: "Interests must be an array.", res, status: 400 });
        }
        // Gender Validation
        const validGenders = ['male', 'female'];
        if (!validGenders.includes(gender)) {
            return (0, error_1.throwError)({ message: "Gender must be either 'male' or 'female'.", res, status: 400 });
        }
        // Birthday Validation
        if (isNaN(new Date(birthday).getTime())) {
            return (0, error_1.throwError)({ message: "Invalid birthday format.", res, status: 400 });
        }
        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
        if (!passwordRegex.test(password)) {
            return (0, error_1.throwError)({
                message: "Password must be at least 8 characters long, include an uppercase letter, lowercase letter, a number, and a special character.",
                res,
                status: 400
            });
        }
        const hashedPassword = yield bcrypt_1.default.hash(password, 12);
        // Family Assignment
        let family = yield family_model_1.Family.findOne({ email });
        if (!family) {
            family = new family_model_1.Family({
                familyName: familyName,
                email,
                familyAvatar: familyAvatar,
                members: [],
                createdAt: new Date()
            });
            yield family.save();
        }
        else {
            if (family.familyName !== familyName) {
                return (0, error_1.throwError)({ message: "Wrong family name", res, status: 400 });
            }
        }
        // Check if a family member with the same name already exists
        const existingFamilyMember = yield user_model_1.User.findOne({ name, familyId: family._id });
        if (existingFamilyMember) {
            return (0, error_1.throwError)({ message: "A member with this name already exists in the family.", res, status: 400 });
        }
        // Create the user and link to family
        const newUser = yield user_model_1.User.create(Object.assign(Object.assign({}, data), { password: hashedPassword, familyId: family._id }));
        // Add user to the family members list if not already present
        if (!family.members.includes(newUser.id)) {
            family.members.push({ _id: newUser.id, role, name, gender, avatar });
            yield family.save();
        }
        if (!JWT_SECRET_KEY) {
            return (0, error_1.throwError)({ message: "JWT_SECRET_KEY is not defined", res, status: 500 });
        }
        const token = yield jsonwebtoken_1.default.sign({ userId: newUser.id, role: newUser.role }, JWT_SECRET_KEY);
        res.status(200).send({ user: newUser, token: token, family: family });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Something went wrong while registering.", res, status: 500 });
    }
});
exports.register = register;
// forget password API
const forgetPassword = (req, res) => __awaiter(void 0, void 0, void 0, function* () {
    try {
        const { name, email } = req.body;
        const user = yield user_model_1.User.findOne({ email, name });
        if (!user) {
            return (0, error_1.throwError)({ message: "Invalid credentials. User not found.", res, status: 404 });
        }
        const tempPassword = (0, generateSecurePassword_1.generateSecurePassword)();
        const hashedPassword = yield bcrypt_1.default.hash(tempPassword, 12);
        user.password = hashedPassword;
        user.isTempPassword = true;
        user.passwordChangedAt = new Date();
        yield user.save();
        const from = `"Guardian Grove" <${process.env.EMAIL_USERNAME}>`;
        const to = email;
        const subject = "Your Temporary Password";
        const html = `
            <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
                <h2 style="color: #2c3e50;">Hello ${user.name},</h2>
                <p>Your temporary password is: <strong>${tempPassword}</strong></p>
                <p>This password will expire in 1 hour.</p>
                <p>Please use this to login and change your password immediately.</p>
                <br/>
                <p>Thank you,</p>
                <p><strong>Guardian Grove Team</strong></p>
            </div>
        `;
        // Send email with the temporary password
        yield (0, email_service_1.sendMail)(from, to, subject, html);
        res.status(200).send({ message: "Temporary password sent to your email." });
    }
    catch (error) {
        return (0, error_1.throwError)({ message: "Error sending temporary password.", res, status: 500 });
    }
});
exports.forgetPassword = forgetPassword;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiQzpcXFVzZXJzXFxVU0VSXFxEZXNrdG9wXFxndWFyZGlhbi1ncm92ZVxcZ3VhcmRpYW4tZ3JvdmUtYmFja2VuZFxcc3JjXFxjb250cm9sbGVyc1xcYXV0aC5jb250cm9sbGVyLnRzIiwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7OztBQUNBLG9EQUE0QjtBQUM1QiwwQ0FBNEM7QUFDNUMscURBQTRDO0FBQzVDLG9EQUE0QjtBQUM1QixnRUFBK0I7QUFDL0IseURBQWdEO0FBQ2hELDRFQUF5RTtBQUN6RSw2REFBcUQ7QUFFckQsZ0JBQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVoQixNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQztBQUc5QyxRQUFRO0FBQ0QsTUFBTSxLQUFLLEdBQUcsQ0FBUSxHQUFZLEVBQUUsR0FBYSxFQUFrQixFQUFFO0lBRXhFLElBQUcsQ0FBQztRQUNBLE1BQU0sRUFBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLFFBQVEsRUFBQyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUM7UUFFekMsSUFBSSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQy9CLE9BQU8sSUFBQSxrQkFBVSxFQUFDLEVBQUUsT0FBTyxFQUFFLHlDQUF5QyxFQUFFLEdBQUcsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztRQUNoRyxDQUFDO1FBRUQsTUFBTSxJQUFJLEdBQUcsTUFBTSxpQkFBSSxDQUFDLE9BQU8sQ0FBQztZQUM1QixJQUFJLEVBQUUsSUFBSTtZQUNWLEtBQUssRUFBRSxLQUFLO1NBQ2YsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO1lBQ1IsT0FBTyxJQUFBLGtCQUFVLEVBQUMsRUFBRSxPQUFPLEVBQUUsc0NBQXNDLEVBQUUsR0FBRyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsQ0FBQyxDQUFDO1FBQzdGLENBQUM7UUFFRCxrQkFBa0I7UUFDbEIsTUFBTSxP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QixNQUFNLE9BQU8sR0FBVyx5QkFBeUIsQ0FBQztRQUVsRCxNQUFNLElBQUksR0FBVzs7b0RBRXVCLElBQUksQ0FBQyxJQUFJO3lEQUNKLFlBQVk7Ozs7Ozs7U0FPNUQsQ0FBQTtRQUVELHlDQUF5QztRQUN6QyxNQUFNLElBQUEsd0JBQVEsRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsQ0FBQztRQUV4QyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxFQUFFLE9BQU8sRUFBRSx3Q0FBd0MsRUFBRSxDQUFDLENBQUM7SUFFaEYsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDYixPQUFPLElBQUEsa0JBQVUsRUFBQyxFQUFFLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSxHQUFHLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUM7SUFDekYsQ0FBQztBQUNMLENBQUMsQ0FBQSxDQUFBO0FBMUNZLFFBQUEsY0FBYyxrQkEwQzFCIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIkM6XFxVc2Vyc1xcVVNFUlxcRGVza3RvcFxcZ3VhcmRpYW4tZ3JvdmVcXGd1YXJkaWFuLWdyb3ZlLWJhY2tlbmRcXHNyY1xcY29udHJvbGxlcnNcXGF1dGguY29udHJvbGxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBSZXNwb25zZSwgUmVxdWVzdCB9IGZyb20gXCJleHByZXNzXCI7XHJcbmltcG9ydCBiY3J5cHQgZnJvbSBcImJjcnlwdFwiO1xyXG5pbXBvcnQgeyB0aHJvd0Vycm9yIH0gZnJvbSBcIi4uL3V0aWxzL2Vycm9yXCI7XHJcbmltcG9ydCB7IFVzZXIgfSBmcm9tIFwiLi4vbW9kZWxzL3VzZXIubW9kZWxcIjtcclxuaW1wb3J0IGRvdGVudiBmcm9tIFwiZG90ZW52XCI7XHJcbmltcG9ydCBqd3QgZnJvbSBcImpzb253ZWJ0b2tlblwiO1xyXG5pbXBvcnQgeyBGYW1pbHkgfSBmcm9tIFwiLi4vbW9kZWxzL2ZhbWlseS5tb2RlbFwiO1xyXG5pbXBvcnQgeyBnZW5lcmF0ZVNlY3VyZVBhc3N3b3JkIH0gZnJvbSBcIi4uL3V0aWxzL2dlbmVyYXRlU2VjdXJlUGFzc3dvcmRcIjtcclxuaW1wb3J0IHsgc2VuZE1haWwgfSBmcm9tIFwiLi4vc2VydmljZXMvZW1haWwuc2VydmljZVwiO1xyXG5cclxuZG90ZW52LmNvbmZpZygpO1xyXG5cclxuY29uc3QgSldUX1NFQ1JFVF9LRVkgPSBwcm9jZXNzLmVudi5KV1RfU0VDUkVUO1xyXG5cclxuXHJcbi8vIGxvZ2luXHJcbmV4cG9ydCBjb25zdCBsb2dpbiA9IGFzeW5jICggcmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA6IFByb21pc2U8dm9pZD4gPT4ge1xyXG5cclxuICAgIHRyeXtcclxuICAgICAgICBjb25zdCB7bmFtZSwgZW1haWwsIHBhc3N3b3JkfSA9IHJlcS5ib2R5O1xyXG5cclxuICAgICAgICBpZiAoIW5hbWUgfHwgIWVtYWlsIHx8ICFwYXNzd29yZCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiTmFtZSwgZW1haWwsIGFuZCBwYXNzd29yZCBhcmUgcmVxdWlyZWQuXCIsIHJlcywgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7XHJcbiAgICAgICAgICAgIG5hbWU6IG5hbWUsXHJcbiAgICAgICAgICAgIGVtYWlsOiBlbWFpbCwgXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGlmICghdXNlcikge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiSW52YWxpZCBjcmVkZW50aWFscy4gVXNlciBub3QgZm91bmQuXCIsIHJlcywgc3RhdHVzOiA0MDQgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBWZXJpZnkgcGFzc3dvcmRcclxuICAgICAgICBjb25zdCBpc01hdGNoID0gYXdhaXQgYmNyeXB0LmNvbXBhcmUocGFzc3dvcmQsIHVzZXIucGFzc3dvcmQpO1xyXG4gICAgICAgIGlmICghaXNNYXRjaCkge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiSW52YWxpZCBwYXNzd29yZC5cIiwgcmVzLCBzdGF0dXM6IDQwMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICghSldUX1NFQ1JFVF9LRVkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkpXVF9TRUNSRVRfS0VZIGlzIG5vdCBkZWZpbmVkXCIsIHJlcywgc3RhdHVzOiA1MDAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IGp3dC5zaWduKHsgdXNlcklkOiB1c2VyLmlkLCByb2xlOiB1c2VyLnJvbGUgfSwgSldUX1NFQ1JFVF9LRVkpO1xyXG5cclxuICAgICAgICByZXMuc3RhdHVzKDIwMCkuanNvbih7XHJcbiAgICAgICAgICAgIHVzZXI6IHVzZXIsXHJcbiAgICAgICAgICAgIHRva2VuLFxyXG4gICAgICAgICAgICByZXF1aXJlc1Bhc3N3b3JkQ2hhbmdlOiB1c2VyLmlzVGVtcFBhc3N3b3JkIHx8IGZhbHNlLFxyXG4gICAgICAgICAgICBtZXNzYWdlOiB1c2VyLmlzVGVtcFBhc3N3b3JkIFxyXG4gICAgICAgICAgICAgICAgPyAnUGxlYXNlIHNldCBhIG5ldyBwYXNzd29yZCcgXHJcbiAgICAgICAgICAgICAgICA6ICdMb2dpbiBzdWNjZXNzZnVsJ1xyXG4gICAgICAgIH0pO1xyXG4gICAgfWNhdGNoKGVycm9yKXtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgbG9nZ2luZyBpbi5cIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG4vLyByZWdpc3RlclxyXG5leHBvcnQgY29uc3QgcmVnaXN0ZXIgPSBhc3luYyAocmVxOiBSZXF1ZXN0LCByZXM6IFJlc3BvbnNlKSA6IFByb21pc2U8dm9pZD4gPT4ge1xyXG4gICAgdHJ5e1xyXG4gICAgICAgIGNvbnN0IGRhdGEgPSByZXEuYm9keTtcclxuICAgICAgICBjb25zdCB7IG5hbWUsIGVtYWlsLCBwYXNzd29yZCwgY29uZmlybVBhc3N3b3JkLCBiaXJ0aGRheSwgZ2VuZGVyLCByb2xlLCBhdmF0YXIsIGludGVyZXN0cywgZmFtaWx5TmFtZSwgZmFtaWx5QXZhdGFyIH0gPSBkYXRhO1xyXG4gICAgICAgIFxyXG4gICAgICAgIC8vIHZlcmlmeSBhbGwgZmllbGRzIGFyZSBmaWxsZWRcclxuICAgICAgICBpZiAoIW5hbWUgfHwgIWVtYWlsIHx8ICFwYXNzd29yZCB8fCAhY29uZmlybVBhc3N3b3JkIHx8ICFiaXJ0aGRheSB8fCAhZ2VuZGVyIHx8ICFyb2xlIHx8ICFhdmF0YXIgfHwgIWludGVyZXN0cyB8fCAhZmFtaWx5TmFtZSB8fCAhZmFtaWx5QXZhdGFyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBbGwgcmVxdWlyZWQgZmllbGRzIG11c3QgYmUgZmlsbGVkLlwiLCByZXMsIHN0YXR1czogNDAwfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGFzc3dvcmQgIT09IGNvbmZpcm1QYXNzd29yZCl7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJQYXNzd29yZHMgZG8gbm90IG1hdGNoXCIsIHJlcywgc3RhdHVzOiA0MDAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBFbWFpbCBWYWxpZGF0aW9uXHJcbiAgICAgICAgY29uc3QgZW1haWxSZWdleCA9IC9eXFx3KyhbXFwuLV0/XFx3KykqQFxcdysoW1xcLi1dP1xcdyspKihcXC5cXHd7MiwzfSkrJC87XHJcbiAgICAgICAgaWYgKCFlbWFpbFJlZ2V4LnRlc3QoZW1haWwpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJJbnZhbGlkIGVtYWlsIGZvcm1hdC5cIiwgcmVzLCBzdGF0dXM6IDQwMH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gUm9sZSB2YWxpZGF0aW9uXHJcbiAgICAgICAgY29uc3QgdmFsaWRSb2xlcyA9IFsncGFyZW50JywgJ2FkbWluJ107XHJcbiAgICAgICAgaWYgKCF2YWxpZFJvbGVzLmluY2x1ZGVzKHJvbGUpKSB7XHJcbiAgICAgICAgICAgIGlmIChyb2xlID09PSBcImNoaWxkXCIpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkNoaWxkcmVuIG11c3QgYmUgYWRkZWQgYnkgYSBwYXJlbnQuXCIsIHJlcywgc3RhdHVzOiA0MDB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiSW52YWxpZCByb2xlLlwiLCByZXMsIHN0YXR1czogNDAwfSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghQXJyYXkuaXNBcnJheShpbnRlcmVzdHMpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJJbnRlcmVzdHMgbXVzdCBiZSBhbiBhcnJheS5cIiwgcmVzLCBzdGF0dXM6IDQwMCB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEdlbmRlciBWYWxpZGF0aW9uXHJcbiAgICAgICAgY29uc3QgdmFsaWRHZW5kZXJzID0gWydtYWxlJywgJ2ZlbWFsZSddO1xyXG4gICAgICAgIGlmICghdmFsaWRHZW5kZXJzLmluY2x1ZGVzKGdlbmRlcikpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkdlbmRlciBtdXN0IGJlIGVpdGhlciAnbWFsZScgb3IgJ2ZlbWFsZScuXCIsIHJlcywgc3RhdHVzOiA0MDB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEJpcnRoZGF5IFZhbGlkYXRpb25cclxuICAgICAgICBpZiAoaXNOYU4obmV3IERhdGUoYmlydGhkYXkpLmdldFRpbWUoKSkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkludmFsaWQgYmlydGhkYXkgZm9ybWF0LlwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgcGFzc3dvcmRSZWdleCA9IC9eKD89LipbYS16XSkoPz0uKltBLVpdKSg/PS4qXFxkKSg/PS4qW0AkISUqPyZdKVtBLVphLXpcXGRAJCElKj8mXXs4LH0kLztcclxuICAgICAgICBpZiAoIXBhc3N3b3JkUmVnZXgudGVzdChwYXNzd29yZCkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3Ioe1xyXG4gICAgICAgICAgICAgICAgbWVzc2FnZTogXCJQYXNzd29yZCBtdXN0IGJlIGF0IGxlYXN0IDggY2hhcmFjdGVycyBsb25nLCBpbmNsdWRlIGFuIHVwcGVyY2FzZSBsZXR0ZXIsIGxvd2VyY2FzZSBsZXR0ZXIsIGEgbnVtYmVyLCBhbmQgYSBzcGVjaWFsIGNoYXJhY3Rlci5cIixcclxuICAgICAgICAgICAgICAgIHJlcyxcclxuICAgICAgICAgICAgICAgIHN0YXR1czogNDAwXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgaGFzaGVkUGFzc3dvcmQgPSBhd2FpdCBiY3J5cHQuaGFzaChwYXNzd29yZCwgMTIpO1xyXG5cclxuXHJcbiAgICAgICAgIC8vIEZhbWlseSBBc3NpZ25tZW50XHJcbiAgICAgICAgIGxldCBmYW1pbHkgPSBhd2FpdCBGYW1pbHkuZmluZE9uZSh7IGVtYWlsIH0pO1xyXG5cclxuICAgICAgICAgaWYgKCFmYW1pbHkpIHtcclxuICAgICAgICAgICAgZmFtaWx5ID0gbmV3IEZhbWlseSh7XHJcbiAgICAgICAgICAgICAgICBmYW1pbHlOYW1lOiBmYW1pbHlOYW1lLFxyXG4gICAgICAgICAgICAgICAgZW1haWwsXHJcbiAgICAgICAgICAgICAgICBmYW1pbHlBdmF0YXI6IGZhbWlseUF2YXRhcixcclxuICAgICAgICAgICAgICAgIG1lbWJlcnM6IFtdLFxyXG4gICAgICAgICAgICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICBhd2FpdCBmYW1pbHkuc2F2ZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICBpZiAoZmFtaWx5LmZhbWlseU5hbWUgIT09IGZhbWlseU5hbWUpe1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIldyb25nIGZhbWlseSBuYW1lXCIsIHJlcywgc3RhdHVzOiA0MDAgfSlcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgYSBmYW1pbHkgbWVtYmVyIHdpdGggdGhlIHNhbWUgbmFtZSBhbHJlYWR5IGV4aXN0c1xyXG4gICAgICAgIGNvbnN0IGV4aXN0aW5nRmFtaWx5TWVtYmVyID0gYXdhaXQgVXNlci5maW5kT25lKHsgbmFtZSwgZmFtaWx5SWQ6IGZhbWlseS5faWQgfSk7XHJcbiAgICAgICAgaWYgKGV4aXN0aW5nRmFtaWx5TWVtYmVyKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJBIG1lbWJlciB3aXRoIHRoaXMgbmFtZSBhbHJlYWR5IGV4aXN0cyBpbiB0aGUgZmFtaWx5LlwiLCByZXMsIHN0YXR1czogNDAwIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQ3JlYXRlIHRoZSB1c2VyIGFuZCBsaW5rIHRvIGZhbWlseVxyXG4gICAgICAgIGNvbnN0IG5ld1VzZXIgPSBhd2FpdCBVc2VyLmNyZWF0ZSh7Li4uZGF0YSwgcGFzc3dvcmQ6IGhhc2hlZFBhc3N3b3JkLCBmYW1pbHlJZDogZmFtaWx5Ll9pZH0pOyBcclxuXHJcbiAgICAgICAgLy8gQWRkIHVzZXIgdG8gdGhlIGZhbWlseSBtZW1iZXJzIGxpc3QgaWYgbm90IGFscmVhZHkgcHJlc2VudFxyXG4gICAgICAgIGlmICghZmFtaWx5Lm1lbWJlcnMuaW5jbHVkZXMobmV3VXNlci5pZCkpIHtcclxuICAgICAgICAgICAgZmFtaWx5Lm1lbWJlcnMucHVzaCh7X2lkOiBuZXdVc2VyLmlkLCByb2xlLCBuYW1lLCBnZW5kZXIsIGF2YXRhcn0pO1xyXG4gICAgICAgICAgICBhd2FpdCBmYW1pbHkuc2F2ZSgpO1xyXG4gICAgICAgIH1cclxuXHJcblxyXG4gICAgICAgIGlmICghSldUX1NFQ1JFVF9LRVkpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkpXVF9TRUNSRVRfS0VZIGlzIG5vdCBkZWZpbmVkXCIsIHJlcywgc3RhdHVzOiA1MDAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBjb25zdCB0b2tlbiA9IGF3YWl0IGp3dC5zaWduKHsgdXNlcklkOiBuZXdVc2VyLmlkLCByb2xlOiBuZXdVc2VyLnJvbGUgIH0sIEpXVF9TRUNSRVRfS0VZKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoe3VzZXI6IG5ld1VzZXIsIHRva2VuOiB0b2tlbiwgZmFtaWx5OiBmYW1pbHl9KTtcclxuXHJcbiAgICB9Y2F0Y2goZXJyb3Ipe1xyXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKHsgbWVzc2FnZTogXCJTb21ldGhpbmcgd2VudCB3cm9uZyB3aGlsZSByZWdpc3RlcmluZy5cIiwgcmVzLCBzdGF0dXM6IDUwMH0pO1xyXG4gICAgfVxyXG59ICBcclxuXHJcbi8vIGZvcmdldCBwYXNzd29yZCBBUElcclxuZXhwb3J0IGNvbnN0IGZvcmdldFBhc3N3b3JkID0gYXN5bmMgKHJlcTogUmVxdWVzdCwgcmVzOiBSZXNwb25zZSkgOiBQcm9taXNlPHZvaWQ+ID0+IHtcclxuICAgIHRyeSB7XHJcbiAgICAgICAgY29uc3QgeyBuYW1lLCBlbWFpbCB9ID0gcmVxLmJvZHk7XHJcbiAgICAgICAgY29uc3QgdXNlciA9IGF3YWl0IFVzZXIuZmluZE9uZSh7IGVtYWlsLCBuYW1lIH0pO1xyXG5cclxuICAgICAgICBpZiAoIXVzZXIpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHRocm93RXJyb3IoeyBtZXNzYWdlOiBcIkludmFsaWQgY3JlZGVudGlhbHMuIFVzZXIgbm90IGZvdW5kLlwiLCByZXMsIHN0YXR1czogNDA0IH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgY29uc3QgdGVtcFBhc3N3b3JkID0gZ2VuZXJhdGVTZWN1cmVQYXNzd29yZCgpO1xyXG4gICAgICAgIGNvbnN0IGhhc2hlZFBhc3N3b3JkID0gYXdhaXQgYmNyeXB0Lmhhc2godGVtcFBhc3N3b3JkLCAxMik7XHJcblxyXG4gICAgICAgIHVzZXIucGFzc3dvcmQgPSBoYXNoZWRQYXNzd29yZDtcclxuICAgICAgICB1c2VyLmlzVGVtcFBhc3N3b3JkID0gdHJ1ZTtcclxuICAgICAgICB1c2VyLnBhc3N3b3JkQ2hhbmdlZEF0ID0gbmV3IERhdGUoKTtcclxuICAgICAgICBhd2FpdCB1c2VyLnNhdmUoKTtcclxuXHJcblxyXG4gICAgICAgIGNvbnN0IGZyb206IHN0cmluZyA9IGBcIkd1YXJkaWFuIEdyb3ZlXCIgPCR7cHJvY2Vzcy5lbnYuRU1BSUxfVVNFUk5BTUV9PmA7XHJcbiAgICAgICAgY29uc3QgdG86IHN0cmluZyA9IGVtYWlsO1xyXG4gICAgICAgIGNvbnN0IHN1YmplY3Q6IHN0cmluZyA9IFwiWW91ciBUZW1wb3JhcnkgUGFzc3dvcmRcIjtcclxuXHJcbiAgICAgICAgY29uc3QgaHRtbDogc3RyaW5nID0gYFxyXG4gICAgICAgICAgICA8ZGl2IHN0eWxlPVwiZm9udC1mYW1pbHk6IEFyaWFsLCBzYW5zLXNlcmlmOyBtYXgtd2lkdGg6IDYwMHB4OyBtYXJnaW46IDAgYXV0bztcIj5cclxuICAgICAgICAgICAgICAgIDxoMiBzdHlsZT1cImNvbG9yOiAjMmMzZTUwO1wiPkhlbGxvICR7dXNlci5uYW1lfSw8L2gyPlxyXG4gICAgICAgICAgICAgICAgPHA+WW91ciB0ZW1wb3JhcnkgcGFzc3dvcmQgaXM6IDxzdHJvbmc+JHt0ZW1wUGFzc3dvcmR9PC9zdHJvbmc+PC9wPlxyXG4gICAgICAgICAgICAgICAgPHA+VGhpcyBwYXNzd29yZCB3aWxsIGV4cGlyZSBpbiAxIGhvdXIuPC9wPlxyXG4gICAgICAgICAgICAgICAgPHA+UGxlYXNlIHVzZSB0aGlzIHRvIGxvZ2luIGFuZCBjaGFuZ2UgeW91ciBwYXNzd29yZCBpbW1lZGlhdGVseS48L3A+XHJcbiAgICAgICAgICAgICAgICA8YnIvPlxyXG4gICAgICAgICAgICAgICAgPHA+VGhhbmsgeW91LDwvcD5cclxuICAgICAgICAgICAgICAgIDxwPjxzdHJvbmc+R3VhcmRpYW4gR3JvdmUgVGVhbTwvc3Ryb25nPjwvcD5cclxuICAgICAgICAgICAgPC9kaXY+XHJcbiAgICAgICAgYFxyXG5cclxuICAgICAgICAvLyBTZW5kIGVtYWlsIHdpdGggdGhlIHRlbXBvcmFyeSBwYXNzd29yZFxyXG4gICAgICAgIGF3YWl0IHNlbmRNYWlsKGZyb20sIHRvLCBzdWJqZWN0LCBodG1sKTtcclxuXHJcbiAgICAgICAgcmVzLnN0YXR1cygyMDApLnNlbmQoeyBtZXNzYWdlOiBcIlRlbXBvcmFyeSBwYXNzd29yZCBzZW50IHRvIHlvdXIgZW1haWwuXCIgfSk7XHJcblxyXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcclxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcih7IG1lc3NhZ2U6IFwiRXJyb3Igc2VuZGluZyB0ZW1wb3JhcnkgcGFzc3dvcmQuXCIsIHJlcywgc3RhdHVzOiA1MDB9KTtcclxuICAgIH1cclxufSJdLCJ2ZXJzaW9uIjozfQ==